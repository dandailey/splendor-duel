<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Splendor Duel</title>
    <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(s){if(s.ep)return;s.ep=!0;const l=n(s);fetch(s.href,l)}})();const Qt=`level,color,points,crowns,ability,is_double,cost_w,cost_bl,cost_g,cost_r,cost_bk,cost_p\r
1,wild,,3,,,,,,,8,\r
1,none,6,,,,8,,,,,\r
1,blue,3,2,,,3,,3,,5,1\r
1,black,3,2,,,3,,5,3,,1\r
1,black,4,,,,2,,,2,6,\r
1,green,4,,,,,2,6,2,,\r
1,white,4,,,,6,2,,,2,\r
1,wild,3,,again,,,,,8,,\r
1,red,3,2,,,,5,3,,3,1\r
1,green,3,2,,,5,3,,3,,1\r
1,white,3,2,,,,3,,5,3,1\r
1,red,4,,,,,,2,6,2,\r
1,blue,4,,,,2,6,2,,,\r
2,green,1,,steal,,3,,,4,,\r
2,blue,2,,scroll,,2,4,,,,1\r
2,green,2,1,,,2,2,,,2,1\r
2,green,1,,,yes,,,,5,2,\r
2,white,1,,,yes,,5,2,,,\r
2,red,1,,,yes,2,,,,5,\r
2,black,2,,scroll,,,,,2,4,1\r
2,red,1,,,,2,2,2,,,1\r
2,red,2,,scroll,,,,2,4,,1\r
2,wild,2,,,,,,6,,,1\r
2,white,1,,steal,,,4,,3,,\r
2,wild,,2,,,,,6,,,1\r
2,wild,,2,,,,6,,,,1\r
2,white,2,1,,,,,2,2,2,1\r
2,black,2,1,,,,2,2,2,,1\r
2,blue,2,1,,,2,,,2,2,1\r
2,red,1,,steal,,,3,,,4,\r
2,white,2,,scroll,,4,,,,2,1\r
2,green,2,,scroll,,,2,4,,,1\r
2,blue,1,,steal,,,,4,,3,\r
2,black,1,,steal,,4,,3,,,\r
2,none,5,,,,,6,,,,1\r
2,black,1,,,yes,5,2,,,,\r
2,blue,1,,,yes,,,5,2,,\r
3,black,,,,,1,1,1,1,,\r
3,blue,,,token,,2,,,,2,\r
3,red,,,token,,,2,2,,,\r
3,black,1,,,,3,,,,,\r
3,black,1,,,,,2,2,,,\r
3,black,,,token,,,,2,2,,\r
3,white,,,token,,,,,2,2,\r
3,black,,,again,,2,2,,,,1\r
3,green,,1,,,,,,3,,\r
3,white,,,again,,,2,2,,,1\r
3,wild,1,,,,,2,,2,1,1\r
3,green,,,again,,,,,2,2,1\r
3,red,,,again,,2,,,,2,1\r
3,none,3,,,,,,,4,,1\r
3,green,1,,,,3,,,,2,\r
3,blue,,,,,1,,1,1,1,\r
3,blue,,,again,,,,2,2,,1\r
3,wild,1,,,,2,,2,,1,1\r
3,green,,,,,1,1,,1,1,\r
3,white,,1,,,,3,,,,\r
3,red,,,,,1,1,1,,1,\r
3,red,,,,,2,3,,,,\r
3,blue,1,,,,,,,2,3,\r
3,blue,,1,,,,,3,,,\r
3,wild,1,,,,,4,,,,1\r
3,green,,,token,,2,2,,,,\r
3,white,,,,,,1,1,1,1,\r
3,red,,1,,,,,,,3,\r
3,wild,,1,,,4,,,,,1\r
3,white,1,,,,,,2,3,,`;let ce=[];const je="splendor_duel_",c={decks:{level1:[],level2:[],level3:[]},initialDeckSizes:{level1:0,level2:0,level3:0},pyramid:{level1:[],level2:[],level3:[]},bag:{blue:4,white:4,green:4,black:4,red:4,pearl:2,gold:3},board:Array(5).fill(null).map(()=>Array(5).fill(null)),royalCards:[],scrollPool:3,players:{player1:{tokens:{blue:0,white:0,green:0,black:0,red:0,pearl:0,gold:0},cards:[],reserves:[],privileges:0},player2:{tokens:{blue:0,white:0,green:0,black:0,red:0,pearl:0,gold:0},cards:[],reserves:[],privileges:0}},currentPlayer:1,syncAssignments:{player1Id:null,player2Id:null}},$={activePlayerId:"player1",opponentPlayerId:"player2"},xt=()=>({turns:[],pendingTurn:null,nextTurnId:1});let B=xt();const St=()=>{B=xt(),p.lastSeenTurnId=null},$t=()=>c.currentPlayer===1?"player1":"player2",Ke=()=>$.activePlayerId?$.activePlayerId:c.currentPlayer===1?"player1":"player2",$e=()=>p.enabled&&p.localPlayerId?p.localPlayerId:$t(),Zt=()=>{const e=$t();return(!B.pendingTurn||B.pendingTurn.playerId!==e)&&(B.pendingTurn={id:`turn-${B.nextTurnId++}`,playerId:e,startedAt:Date.now(),events:[]}),B.pendingTurn},It=(e=[])=>{const t={};return e.forEach(n=>{n&&(t[n]=(t[n]||0)+1)}),Object.keys(t).map(n=>({color:n,count:t[n]}))},Ie=e=>({id:e.id,level:e.level,color:e.color,points:e.points||0,crowns:e.crowns||0,ability:e.ability||null,isDouble:!!e.isDouble,costs:e.costs?{...e.costs}:{}}),Ct=(e={})=>Object.keys(e).filter(t=>e[t]>0).map(t=>({color:t,count:e[t]})),X=(e,t={})=>{const n=Zt();n.events.push({id:`${n.id}-event-${n.events.length+1}`,type:e,timestamp:Date.now(),...t}),n.updatedAt=Date.now()},pt=(e="completed")=>{const t=B.pendingTurn;if(t){if(!t.events.length){B.pendingTurn=null;return}t.endedAt=Date.now(),t.status=e,t.turnNumber=(B.turns?.length||0)+1,B.turns.push(t),B.pendingTurn=null}};let Qe=null,qe="";const te={player1:0,player2:0};let Y=null,oe=!1,ee=!1,J=null,W=!1,F=[],Ze=!1,ge=0;const ut="splendor_duel_client_id",yt=()=>{try{if(crypto&&typeof crypto.randomUUID=="function")return crypto.randomUUID()}catch{}return`sd-${Date.now()}-${Math.floor(Math.random()*1e9)}`},en=()=>{try{const e=window.localStorage.getItem(ut);if(e)return e;const t=yt();return window.localStorage.setItem(ut,t),t}catch(e){return console.warn("Unable to access localStorage for client ID:",e),yt()}},Z=en();console.log("Splendor Duel client ID:",Z);const p={enabled:!1,serviceAvailable:!1,sessionId:null,version:null,localPlayerId:null,isHost:!1,pollTimerId:null,syncStatus:"offline",lastSeenTurnId:null};class tn{constructor(t,n){this.baseUrl=t,this.gameType=n,this.sessionId=null,this.version=null,this.serviceAvailable=!1,this.pollTimerId=null}async checkStatus(){try{const t=new AbortController,n=setTimeout(()=>t.abort(),3e3),o=await fetch(`${this.baseUrl}?action=status`,{method:"GET",signal:t.signal});if(clearTimeout(n),o.ok){const s=await o.json();return this.serviceAvailable=s.status==="operational",this.serviceAvailable}return this.serviceAvailable=!1,!1}catch{return this.serviceAvailable=!1,!1}}async createSession(t,n={}){const o=await fetch(`${this.baseUrl}?action=create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({game_type:this.gameType,state_blob:t,meta:n})});if(!o.ok){const l=await o.json().catch(()=>({error:"Unknown error"}));throw{type:"create_failed",status:o.status,message:l.error||`Failed to create session: ${o.status}`}}const s=await o.json();return this.sessionId=s.session_id,this.version=s.version,s}async loadSession(t){const n=new URL(this.baseUrl);n.searchParams.set("action","load"),n.searchParams.set("session_id",t),n.searchParams.set("game_type",this.gameType);const o=await fetch(n);if(o.status===404)throw{type:"not_found",status:404,message:"Session not found"};if(!o.ok){const l=await o.json().catch(()=>({error:"Unknown error"}));throw{type:"load_failed",status:o.status,message:l.error||`Failed to load session: ${o.status}`}}const s=await o.json();return this.sessionId=s.session_id,this.version=s.version,s}async updateSession(t,n=3,o=null){if(!this.sessionId||this.version===null)throw{type:"no_session",message:"No active session"};let s=0,l=this.version;for(;s<n;)try{const a={session_id:this.sessionId,game_type:this.gameType,state_blob:t,version:l},r=await fetch(`${this.baseUrl}?action=update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(r.status===409){const d=await r.json();if(this.version=d.current.version,l=d.current.version,s++,s>=n)throw{type:"version_conflict",status:409,message:"Version conflict: max retries reached",current:d.current};continue}if(!r.ok){const d=await r.json().catch(()=>({error:"Unknown error"}));throw{type:"update_failed",status:r.status,message:d.error||`Failed to update session: ${r.status}`}}const i=await r.json();return this.version=i.version,i}catch(a){if(a.type==="version_conflict"||a.type==="update_failed")throw a;if(s++,s>=n)throw{type:"network_error",message:a.message||"Network error during update"}}}startPolling(t,n){if(this.pollTimerId&&this.stopPolling(),!this.sessionId)throw new Error("No active session for polling");const o=async()=>{try{const s=this.version,l=await this.loadSession(this.sessionId);(s===null||l.version>s)&&(this.version=l.version,n&&n(l))}catch(s){console.error("Poll error:",s),n&&n(null,s)}};o(),this.pollTimerId=setInterval(o,t)}stopPolling(){this.pollTimerId&&(clearInterval(this.pollTimerId),this.pollTimerId=null)}}const nn=()=>{const e=window.location.hostname;return e==="localhost"||e==="127.0.0.1"||e.startsWith("192.168.")||e.startsWith("10.")||e==="gamesync"||window.location.port!==""},on=nn()?"http://gamesync:8888/index.php":"https://danieldailey.com/gamesync/index.php",ye=new tn(on,"splendor_duel"),sn=e=>{const t=e.trim().split(`
`),n=t[0].split(",").map(o=>o.trim());return t.slice(1).map(o=>{const s=o.split(",").map(a=>a.trim()),l={};return n.forEach((a,r)=>{l[a]=s[r]}),gn(l)})},rn=()=>{try{ce=sn(Qt)}catch(e){console.error("Failed to parse cards:",e),ce=[]}},Re=e=>[...e].sort(()=>Math.random()-.5),ln=()=>{const e={1:[],2:[],3:[]};ce.forEach(t=>{e[t.level].push(t)}),c.decks.level1=Re(e[1]),c.decks.level2=Re(e[2]),c.decks.level3=Re(e[3])},an=()=>{c.royalCards=[{id:"royal-1",points:2,ability:"scroll",taken:!1},{id:"royal-2",points:2,ability:"steal",taken:!1},{id:"royal-4",points:2,ability:"again",taken:!1},{id:"royal-3",points:3,ability:null,taken:!1}]},cn=()=>{c.pyramid.level1=c.decks.level1.splice(0,3),c.pyramid.level2=c.decks.level2.splice(0,4),c.pyramid.level3=c.decks.level3.splice(0,5),c.initialDeckSizes.level1=c.decks.level1.length,c.initialDeckSizes.level2=c.decks.level2.length,c.initialDeckSizes.level3=c.decks.level3.length},Pt=e=>{const t=[],n=Math.floor(e/2);let o="right",s=1,l=0,a=0,r=n,i=n;t.push([r,i]);for(let d=1;d<e*e;d++)o==="right"?i++:o==="down"?r++:o==="left"?i--:o==="up"&&r--,t.push([r,i]),l++,l===s&&(l=0,a++,o==="right"?o="down":o==="down"?o="left":o==="left"?o="up":o==="up"&&(o="right"),a===2&&(s++,a=0));return t},dn=()=>{const e=[];["blue","white","green","black","red"].forEach(s=>{for(let l=0;l<4;l++)e.push(s)}),e.push("pearl","pearl"),e.push("gold","gold","gold");const n=Re(e),o=Pt(5);n.forEach((s,l)=>{if(l<25){const[a,r]=o[l];c.board[a][r]=s}}),Object.keys(c.bag).forEach(s=>{c.bag[s]=0})},we=e=>{if(c.scrollPool>0)c.scrollPool--,c.players[e].privileges=(c.players[e].privileges||0)+1;else{const t=e==="player1"?"player2":"player1",n=c.players[t];n.privileges>0&&n.privileges--,c.players[e].privileges=(c.players[e].privileges||0)+1}},Tt=()=>{rn(),ln(),an(),cn(),dn(),c.currentPlayer=Math.random()<.5?1:2;const e=c.currentPlayer===1?"player2":"player1";we(e),$.activePlayerId=c.currentPlayer===1?"player1":"player2",$.opponentPlayerId=c.currentPlayer===1?"player2":"player1",te.player1=0,te.player2=0,ze(),c.syncAssignments.player1Id=null,c.syncAssignments.player2Id=null,St()},pn=()=>({gameState:JSON.parse(JSON.stringify(c)),turnDisplayState:JSON.parse(JSON.stringify($)),previousCrownCounts:JSON.parse(JSON.stringify(te)),turnHistory:JSON.parse(JSON.stringify(B))}),Et=()=>JSON.stringify(pn()),et=e=>{try{const t=JSON.parse(e);if(!t.gameState||!t.turnDisplayState||!t.previousCrownCounts)return console.error("Invalid sync state: missing required fields"),!1;if(Object.keys(t.gameState).forEach(n=>{n==="board"?c.board=t.gameState.board.map(o=>[...o]):n==="players"?Object.keys(t.gameState.players).forEach(o=>{c.players[o]=JSON.parse(JSON.stringify(t.gameState.players[o]))}):n==="decks"||n==="pyramid"?Object.keys(t.gameState[n]).forEach(o=>{c[n][o]=JSON.parse(JSON.stringify(t.gameState[n][o]))}):Array.isArray(t.gameState[n])||typeof t.gameState[n]=="object"&&t.gameState[n]!==null?c[n]=JSON.parse(JSON.stringify(t.gameState[n])):c[n]=t.gameState[n]}),p.enabled||($.activePlayerId=t.turnDisplayState.activePlayerId,$.opponentPlayerId=t.turnDisplayState.opponentPlayerId),te.player1=t.previousCrownCounts.player1,te.player2=t.previousCrownCounts.player2,t.turnHistory){const n=JSON.parse(JSON.stringify(t.turnHistory));B={turns:Array.isArray(n.turns)?n.turns:[],pendingTurn:n.pendingTurn||null,nextTurnId:n.nextTurnId||(n.turns&&n.turns.length?n.turns.length+1:1)}}else St();return ze(),I(),!0}catch(t){return console.error("Failed to apply synced state:",t),!1}},ze=()=>{c.syncAssignments?(typeof c.syncAssignments.player1Id>"u"&&(c.syncAssignments.player1Id=null),typeof c.syncAssignments.player2Id>"u"&&(c.syncAssignments.player2Id=null)):c.syncAssignments={player1Id:null,player2Id:null}},un=()=>p.localPlayerId?p.localPlayerId==="player1"?1:2:null,Mt=()=>p.enabled&&!ke(),tt=()=>{const e=document.getElementById("turn-guard-message");if(e)if(Mt()){const t=qe||"Opponent's turn ‚Äì please wait.";e.textContent=t,e.classList.add("visible")}else e.textContent="",e.classList.remove("visible"),qe=""},yn=(e="Please wait for your opponent to finish their turn.")=>{qe=e,tt(),console.warn(`[Sync Guard] ${e}`)},fn=()=>{qe="",tt()},R=(e="This action is only available on your turn.")=>Mt()?(yn(e),!1):!0,se=e=>e?e.startsWith(je)?e.slice(je.length):e:"",nt=e=>e?e.startsWith(je)?e:`${je}${e}`:null,ot=e=>{if(!e)return"";const t=nt(e)||e,n=se(t),o=new URL(window.location.href);return o.search="",o.hash="",n?o.searchParams.set("session",n):o.searchParams.set("session",t),o.toString()},st=e=>e?`https://api.qrserver.com/v1/create-qr-code/?size=170x170&data=${encodeURIComponent(e)}`:"",ke=()=>{if(!p.enabled||!p.localPlayerId)return!0;const e=un();return c.currentPlayer===e},mn=()=>{if(!p.enabled||!p.localPlayerId)return;const e=p.localPlayerId==="player1"?2:1;c.currentPlayer=e},Lt=async(e="state update")=>{if(!p.enabled||!p.sessionId)return null;try{const t=Et();if(!t||t.length<50)return console.error(`State blob too small (${t?.length}) for update (${e}). Skipping write.`),null;const n=await ye.updateSession(t);return p.version=n.version,p.syncStatus="online",console.log(`State pushed (${e})`,n.version),n}catch(t){throw console.error(`Failed to push state (${e})`,t),t}};let vn=0;const gn=e=>({id:`card-${vn++}`,level:parseInt(e.level),color:e.color,points:parseInt(e.points)||0,crowns:parseInt(e.crowns)||0,ability:e.ability||"",isDouble:e.is_double==="yes",costs:{white:parseInt(e.cost_w)||0,blue:parseInt(e.cost_bl)||0,green:parseInt(e.cost_g)||0,red:parseInt(e.cost_r)||0,black:parseInt(e.cost_bk)||0,pearl:parseInt(e.cost_p)||0}}),me=e=>({blue:"blue",white:"white",green:"green",black:"black",red:"red",wild:"wild"})[e]||"",re=e=>({blue:"#4a90e2",white:"#f0f0f0",green:"#7ed321",black:"#2c3e50",red:"#e74c3c"})[e]||"#999",N=(e=20)=>`<svg viewBox="0 0 24 24" width="${e}" height="${e}" role="img" aria-label="crown">
    <path d="M3 17 L3 8.5 L7 12.2 L10.6 7.2 L12 4.8 L13.4 7.2 L17 12.2 L21 8.5 L21 17 Z" fill="#ffd700" stroke="#c68c00" stroke-width="1" stroke-linejoin="round"/>
    <rect x="4" y="16.5" width="16" height="4" rx="1" fill="#f7d251" stroke="#c68c00" stroke-width="1"/>
    <circle cx="5.2" cy="9" r="1.5" fill="#ffe680" stroke="#c68c00" stroke-width="0.8"/>
    <circle cx="18.8" cy="9" r="1.5" fill="#ffe680" stroke="#c68c00" stroke-width="0.8"/>
    <polygon points="12,6.2 13.4,7.9 12,9.6 10.6,7.9" fill="#d1495b" stroke="#8d2336" stroke-width="0.7" stroke-linejoin="round"/>
  </svg>`;let hn=0;const le=(e=24)=>{const n=`pearlGradient${hn++}`;return`<svg viewBox="0 0 24 24" width="${e}" height="${e}" role="img" aria-label="pearl">
    <defs>
      <radialGradient id="${n}" cx="35%" cy="30%" r="65%">
        <stop offset="0%" stop-color="#ffffff"/>
        <stop offset="45%" stop-color="#ffe6f0"/>
        <stop offset="75%" stop-color="#f6d1e8"/>
        <stop offset="100%" stop-color="#d7a8d6"/>
      </radialGradient>
    </defs>
    <circle cx="12" cy="12" r="12" fill="url(#${n})" stroke="none"/>
  </svg>`};let bn=0;const ae=(e,t=24)=>{const n=bn++,o=`${e}Gradient${n}`,s=`${e}InnerGradient${n}`,l={blue:{gradient:["#6bb4ff","#4a90e2","#357abd","#2c5aa0"],stroke:"#1f3f6e",innerGradient:["#3a6ab8","#4490d5","#4f9ee0","#5aace8"]},white:{gradient:["#ffffff","#f5f5f5","#e5e5e5","#cccccc"],stroke:"#999999",innerGradient:["#e8e8e8","#ebebeb","#efefef","#f2f2f2"]},green:{gradient:["#9ee65b","#7ed321","#6bb018","#5a9f1f"],stroke:"#3d7215",innerGradient:["#6eb539","#72ba3f","#79c148","#7fc850"]},black:{gradient:["#4d5a6b","#2c3e50","#1f2a36","#1a1f2e"],stroke:"#0f1419",innerGradient:["#1f2732","#202835","#232a39","#252d3d"]},red:{gradient:["#ff6b6b","#e74c3c","#c9332a","#c0392b"],stroke:"#a02824",innerGradient:["#d14a41","#d9554c","#e16057","#e96b62"]}},a=l[e]||l.blue;return`<svg viewBox="0 0 24 24" width="${t}" height="${t}" role="img" aria-label="${e} gem">
    <defs>
      <radialGradient id="${o}" cx="40%" cy="30%" r="70%">
        <stop offset="0%" stop-color="${a.gradient[0]}"/>
        <stop offset="40%" stop-color="${a.gradient[1]}"/>
        <stop offset="70%" stop-color="${a.gradient[2]}"/>
        <stop offset="100%" stop-color="${a.gradient[3]}"/>
      </radialGradient>
      <linearGradient id="${s}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="${a.innerGradient[0]}"/>
        <stop offset="40%" stop-color="${a.innerGradient[1]}"/>
        <stop offset="70%" stop-color="${a.innerGradient[2]}"/>
        <stop offset="100%" stop-color="${a.innerGradient[3]}"/>
      </linearGradient>
    </defs>
    <circle cx="12" cy="12" r="12" fill="url(#${o})" stroke="${a.stroke}" stroke-width="0.5"/>
    <circle cx="12" cy="12" r="8" fill="url(#${s})" stroke="${a.stroke}" stroke-width="0.5"/>
  </svg>`};let wn=0;const Ye=(e,t,n=24)=>{if(t===0)return"";const s=n*(1-.4),l=[];for(let i=0;i<t;i++){let d="";e==="scroll"?d=`<span class="privilege-scroll-emoji" style="font-size: ${n}px;">üóûÔ∏è</span>`:e==="pearl"?d=le(n):e==="gold"&&(d=Ce(n));const u=i*s,y=i+1;l.push(`
      <div style="
        position: absolute;
        display: inline-block;
        left: ${u}px;
        top: 0px;
        z-index: ${y};
        filter: drop-shadow(0 0 1px rgba(255, 255, 255, 1)) drop-shadow(0 0 2px rgba(255, 255, 255, 0.8)) drop-shadow(0 0 3px rgba(255, 255, 255, 0.4));
      ">
        ${d}
      </div>
    `)}return`<div style="display: inline-block; position: relative; width: ${(t-1)*s+n}px; height: ${n}px; vertical-align: middle;">${l.join("")}</div>`},Bt=(e,t=24)=>{const n=c.players[e],o=n.privileges||0,s=n.tokens.pearl||0,l=n.tokens.gold||0;if(o===0&&s===0&&l===0)return"";const a=[];return o>0&&a.push(Ye("scroll",o,t)),s>0&&a.push(Ye("pearl",s,t)),l>0&&a.push(Ye("gold",l,t)),`<div style="display: flex; align-items: center; gap: 6px; justify-content: flex-end;">${a.join("")}</div>`},Ce=(e=24)=>{const t=wn++,n=`goldGradient${t}`,o=`goldInnerGradient${t}`;return`<svg viewBox="0 0 24 24" width="${e}" height="${e}" role="img" aria-label="gold coin">
    <defs>
      <radialGradient id="${n}" cx="40%" cy="30%" r="70%">
        <stop offset="0%" stop-color="#fff6a3"/>
        <stop offset="40%" stop-color="#ffd85c"/>
        <stop offset="70%" stop-color="#f4b41a"/>
        <stop offset="100%" stop-color="#c78100"/>
      </radialGradient>
      <linearGradient id="${o}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#e09a28"/>
        <stop offset="40%" stop-color="#e8a53c"/>
        <stop offset="70%" stop-color="#f0b050"/>
        <stop offset="100%" stop-color="#f8bb64"/>
      </linearGradient>
    </defs>
    <circle cx="12" cy="12" r="12" fill="url(#${n})" stroke="#a86b00" stroke-width="0.5"/>
    <circle cx="12" cy="12" r="8" fill="url(#${o})" stroke="#a86b00" stroke-width="0.5"/>
  </svg>`},Ne=(e=28)=>`
  <svg viewBox="0 0 24 24" width="${e}" height="${e}" role="img" aria-label="wild gem">
    <polygon points="12,12 12,2 21.6,8.6" fill="#2c3e50"></polygon>
    <polygon points="12,12 21.6,8.6 18.1,20.3" fill="#f0f0f0" stroke="#ccc"></polygon>
    <polygon points="12,12 18.1,20.3 5.9,20.3" fill="#e74c3c"></polygon>
    <polygon points="12,12 5.9,20.3 2.4,8.6" fill="#7ed321"></polygon>
    <polygon points="12,12 2.4,8.6 12,2" fill="#4a90e2"></polygon>
    <polygon points="12,2 21.6,8.6 18.1,20.3 5.9,20.3 2.4,8.6" fill="none" stroke="#333" stroke-width="0.6"></polygon>
  </svg>
`,Je=e=>{const t={again:"üîÑ",token:"üíé",steal:"‚úã",scroll:"üóûÔ∏è"};return e.ability==="wild"?`<span class="ability-icon">${Ne(18)}</span>`:e.ability&&t[e.ability]?`<span class="ability-icon">${t[e.ability]}</span>`:""},kn=e=>{if(!e.isDouble||!e.color||e.color==="none"||e.color==="wild")return"";const t=me(e.color),n=re(e.color),o=e.color==="white"?"#999":"white";return`<div class="double-indicator">
    <div class="double-circle double-circle-back ${t}" style="background-color: ${n}; border-color: ${o};"></div>
    <div class="double-circle double-circle-front ${t}" style="background-color: ${n}; border-color: ${o};"></div>
  </div>`},xn=e=>{const t=Object.entries(e).filter(([i,d])=>d>0);if(t.length===0)return"";const n=t.find(([i])=>i==="pearl"),o=t.filter(([i])=>i!=="pearl").sort((i,d)=>d[1]-i[1]),s=[{name:"bottom-left",row:2,col:1},{name:"bottom-right",row:2,col:2},{name:"top-left",row:1,col:1},{name:"top-right",row:1,col:2}],l=(i,d)=>{const u=[];return i===1&&u.push("cost-top"),d===2&&u.push("cost-right"),u.join(" ")},a=[];let r=0;for(let i=0;i<s.length;i++){const d=s[i];i+1===2&&n?a.push({cost:n,class:l(d.row,d.col)}):r<o.length?a.push({cost:o[r++],class:l(d.row,d.col)}):a.push(null)}return a.filter(i=>i!==null).map(({cost:i,class:d})=>{const[u,y]=i;if(u==="pearl"){const f=le(24).replace(/width="\d+"/,"").replace(/height="\d+"/,"");return`<div class="cost-item pearl ${d}"><div class="cost-token pearl">${f}</div></div>`}return`<div class="cost-item ${u} ${d}"><div class="cost-token"><span class="cost-number">${y}</span></div></div>`}).join("")},de=(e,t,n=!1)=>{const o=e.color&&e.color!=="none",s=e.color==="wild",l=e.color==="none";s||l||o&&`${me(e.color)}`;let r=`<div class="card card-v2 ${t}${n?" affordable":""}" data-clickable="card" data-popover="card-detail-popover" data-card-level="${e.level}" data-card-index="${e._pyramidIndex??""}" data-card-id="${e.id??""}">`;if(o&&!s?r+=`<div class="card-stripe-top ${me(e.color)}" style="background-color: ${re(e.color)}"></div>`:(s||l)&&(r+=`<div class="card-stripe-top grey" style="background-color: ${l?"#000":"#999"}"></div>`),o&&!s?r+=`<div class="card-stripe-bottom ${me(e.color)}" style="background-color: ${re(e.color)}"></div>`:(s||l)&&(r+=`<div class="card-stripe-bottom grey" style="background-color: ${l?"#000":"#999"}"></div>`),r+='<div class="card-header">',r+="</div>",e.points>0)if(s)r+=`<div class="prestige-points wild-points">${e.points}</div>`;else if(l)r+='<div class="points-corner"></div>',r+=`<div class="prestige-points">${e.points}</div>`;else{const i=e.color==="white"?" white-points":"";r+=`<div class="prestige-points${i}">${e.points}</div>`}return(e.ability||e.isDouble||e.crowns>0)&&(r+='<div class="card-ability-container">',e.crowns>0&&(e.crowns===1?r+=`<div class="card-crowns crown-single">${N(16)}</div>`:e.crowns===2?r+=`<div class="card-crowns crown-stack">${N(16)}${N(16)}</div>`:e.crowns===3&&(r+=`<div class="card-crowns crown-grid">
          ${N(16)}${N(16)}
          <span></span>${N(16)}
        </div>`)),e.ability&&(r+='<span class="card-ability">',r+=Je(e),r+="</span>"),e.isDouble&&(r+=kn(e)),r+="</div>"),r+='<div class="card-costs">',r+=xn(e.costs),r+="</div>",s&&(r+=`<div class="wild-icon-positioned">${Ne(28)}</div>`),r+="</div>",r},Fe=e=>{const t=c.decks[`level${e}`],n=c.initialDeckSizes[`level${e}`],o=t.length,s=n>0?o/n*100:0;return Math.max(0,Math.min(100,s))},Ve=(e=100)=>{const t=e*.006,n=e*.02,o=e*.03,s=e*.04;let l=`<svg viewBox="0 0 ${e} ${e}" width="${e}" height="${e}" class="token-board-svg" preserveAspectRatio="none">`;l+=`<rect x="0" y="0" width="${e}" height="${e}" fill="#8b7765" stroke="#6b5e4a" stroke-width="${n}" rx="${s}" ry="${s}"/>`;const a=e-o*2;l+=`<rect x="${o}" y="${o}" width="${a}" height="${a}" fill="#c7b69a" rx="${s}" ry="${s}"/>`;const r=a;l+=`<defs>
    <radialGradient id="boardGradient" cx="25%" cy="25%" r="120%">
      <stop offset="0%" stop-color="#d9cbb3" stop-opacity="0.6"/>
      <stop offset="50%" stop-color="#d6c7b0" stop-opacity="0.3"/>
      <stop offset="100%" stop-color="#d4c4a8" stop-opacity="0"/>
    </radialGradient>
    <style>
      .token-board-grid { stroke: rgba(139, 119, 101, 0.3); stroke-width: ${t}; fill: none; }
    </style>
  </defs>`,l+=`<rect x="${o}" y="${o}" width="${r}" height="${r}" fill="#d4c4a8"/>`,l+=`<rect x="${o}" y="${o}" width="${r}" height="${r}" fill="url(#boardGradient)"/>`;const i=r/5;for(let u=1;u<5;u++){const y=o+u*i;l+=`<line class="token-board-grid" x1="${o}" y1="${y}" x2="${o+r}" y2="${y}"/>`}for(let u=1;u<5;u++){const y=o+u*i;l+=`<line class="token-board-grid" x1="${y}" y1="${o}" x2="${y}" y2="${o+r}"/>`}const d=i*.35;for(let u=0;u<5;u++)for(let y=0;y<5;y++){const f=c.board[u][y],v=o+y*i,b=o+u*i,w=x.some(P=>P.row===u&&P.col===y);if(l+=`<rect x="${v}" y="${b}" width="${i}" height="${i}" fill="transparent" class="token-cell" data-row="${u}" data-col="${y}" style="cursor: ${f&&f!=="gold"?"pointer":"default"};"/>`,!f)continue;const T=o+(y+.5)*i,C=o+(u+.5)*i,U=d+t,M=U*2,A=4,O=M+A*2,g=T-U-A,S=C-U-A;let k;f==="pearl"?k=le(M).replace(/width="\d+"/,`width="${M}"`).replace(/height="\d+"/,`height="${M}"`):f==="gold"?k=Ce(M).replace(/width="\d+"/,`width="${M}"`).replace(/height="\d+"/,`height="${M}"`):k=ae(f,M).replace(/width="\d+"/,`width="${M}"`).replace(/height="\d+"/,`height="${M}"`);let L="";if(w&&f!=="gold"){const P=U+3;L=`<circle cx="${T}" cy="${C}" r="${P}" fill="none" stroke="#4a90e2" stroke-width="3" opacity="0.8"/>`}l+=`${L}<foreignObject x="${g}" y="${S}" width="${O}" height="${O}"><div style="width: ${M}px; height: ${M}px; margin: ${A}px; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));">${k}</div></foreignObject>`}return l+="</svg>",l},ie=e=>{const t=c.players[e],n={blue:0,white:0,green:0,black:0,red:0,wild:0},o={blue:0,white:0,green:0,black:0,red:0,wild:0},s={blue:!1,white:!1,green:!1,black:!1,red:!1},l={blue:null,white:null,green:null,black:null,red:null};return t.cards.forEach(a=>{const r=a.isDouble?2:1;if(a.color==="wild"&&a.wildColorStack){const i=a.wildColorStack;n[i]=(n[i]||0)+r,o[i]=(o[i]||0)+a.points,l[i]=a}else a.color&&a.color!=="none"&&a.color!=="wild"&&(n[a.color]=(n[a.color]||0)+r,o[a.color]=(o[a.color]||0)+a.points,l[a.color]=a)}),Object.keys(l).forEach(a=>{const r=l[a];r&&r.color==="wild"&&(s[a]=!0)}),{cards:n,points:o,wildStacks:s}},Sn=e=>{const t=c.players[e],n=[],o=[];return t.cards.forEach(s=>{s.color==="none"&&n.push(s)}),t.cards.forEach(s=>{s.id&&s.id.startsWith("royal-")&&o.push(s)}),{greyCards:n,royalCards:o}},rt=e=>{const t=c.players[e];let n=0,o=0;const s={blue:0,white:0,green:0,red:0,black:0};t.cards.forEach(i=>{n+=i.points||0,o+=i.crowns||0,i.color&&i.color!=="none"&&i.color!=="wild"&&(s[i.color]+=i.points||0)});const l=["blue","white","green","red","black"];let a=0,r=l[0];return l.forEach(i=>{s[i]>a&&(a=s[i],r=i)}),{totalPoints:n,totalCrowns:o,colorPoints:s,maxColor:r,maxPoints:a}},H=["blue","white","green","red","black"],pe=(e,t)=>{const n=c.players[t],{cards:o}=ie(t),s={};let l=0;H.forEach(d=>{const u=e.costs[d]||0,y=o[d]||0,f=Math.max(0,u-y);s[d]=f;const v=Math.min(f,n.tokens[d]||0);l+=f-v});const a=e.costs.pearl||0;s.pearl=a;const r=Math.min(a,n.tokens.pearl||0);return l+=a-r,{affordable:l<=(n.tokens.gold||0),deficits:s}},Oe=e=>{const{cards:t,wildStacks:n}=ie(e);return["blue","white","green","red","black"].filter(l=>!((t[l]||0)===0||n[l])).length>0};let m=null;const He=(e,t,n=[])=>{const o=c.players[t],{cards:s}=ie(t),l={gold:0,pearl:0,blue:0,white:0,green:0,red:0,black:0},a={pearl:e.costs.pearl||0};H.forEach(y=>{a[y]=e.costs[y]||0});const r={pearl:a.pearl};H.forEach(y=>{r[y]=Math.max(0,a[y]-(s[y]||0))});const i={pearl:0,blue:0,white:0,green:0,red:0,black:0};(n||[]).forEach(y=>{y&&i.hasOwnProperty(y)&&i[y]++}),Object.keys(i).forEach(y=>{if(i[y]>0&&a[y]>0){const f=r[y]||0,v=f>0?Math.min(i[y],f):Math.min(i[y],1);v>0&&(r[y]=Math.max(0,f-v),l.gold+=v)}});const d=(y,f)=>{const v=r[y]||0,b=Math.min(v,f);l[y]=b,r[y]=Math.max(0,v-b)};return d("pearl",o.tokens.pearl||0),H.forEach(y=>d(y,o.tokens[y]||0)),(r.pearl||0)+H.reduce((y,f)=>y+(r[f]||0),0)>0?{valid:!1,spend:l,message:"Selection does not fully cover the cost."}:{valid:!0,spend:l}},$n=(e,t)=>{const n=c.players[t],{cards:o}=ie(t),s={gold:0,pearl:0,blue:0,white:0,green:0,red:0,black:0},l={...s};H.forEach(d=>{const u=Math.max(0,(e.costs[d]||0)-(o[d]||0)),y=Math.min(u,n.tokens[d]||0);s[d]=y,l[d]=u});const a=e.costs.pearl||0,r=Math.min(a,n.tokens.pearl||0);s.pearl=r,l.pearl=a;let i=0;return H.forEach(d=>{i+=Math.max(0,l[d]-s[d])}),i+=Math.max(0,l.pearl-s.pearl),s.gold=Math.min(i,n.tokens.gold||0),l.gold=i,{selection:s,caps:l}},_t=()=>{const e=document.getElementById("payment-pane");if(!e||!m)return;const t=c.players[m.playerId],n=g=>{const S=Object.entries(g).filter(([j,Me])=>Me&&Me>0),k=S.find(([j])=>j==="pearl"),L=S.filter(([j])=>j!=="pearl"),P=[null,null,null,null];k&&(P[1]=k);let D=0;for(let j=0;j<4;j++)!P[j]&&D<L.length&&(P[j]=L[D++]);return P.filter(Boolean).map(([j])=>j)},o=h?h.costs||{}:{},s=n(o),{cards:l}=ie(m.playerId),a=[],r=8;s.forEach(g=>{if(g==="pearl"){const S=o.pearl||0,k=Math.min(S,t.tokens.pearl||0);for(let L=0;L<k&&a.length<r;L++)a.push(`<span style="display:inline-flex; width:22px; height:22px; align-items:center; justify-content:center; margin:2px;">${le(18)}</span>`)}else{const S=o[g]||0,k=Math.min(S,l[g]||0),L=Math.min(Math.max(0,S-k),t.tokens[g]||0);for(let P=0;P<k&&a.length<r;P++)a.push(`<span title="${g} card" style="display:inline-block; width:22px; height:14px; border-radius:3px; background:${re(g)}; margin:4px 3px; box-shadow:0 1px 2px rgba(0,0,0,.3);"></span>`);for(let P=0;P<L&&a.length<r;P++){const D=g==="black"?"outline: 2px solid rgba(255,255,255,.85); border-radius: 50%;":"";a.push(`<span style="display:inline-flex; width:22px; height:22px; align-items:center; justify-content:center; margin:2px; ${D}">${ae(g,18)}</span>`)}}});const i={};H.forEach(g=>{const S=Math.max(0,(o[g]||0)-(l[g]||0)),k=Math.max(0,S-(t.tokens[g]||0));i[g]=k});const d=Math.max(0,(o.pearl||0)-(t.tokens.pearl||0)),u=[...H.filter(g=>(o[g]||0)>0),...(o.pearl||0)>0?["pearl"]:[]],v=[...H.filter(g=>i[g]>0),...d>0?["pearl"]:[]].reduce((g,S)=>g+(S==="pearl"?d:i[S]),0)<=(t.tokens.gold||0);if(m.goldAssignments){if(m.goldAssignments.length!==(t.tokens.gold||0)){const g=t.tokens.gold||0;m.goldAssignments=Array.from({length:g},(S,k)=>m.goldAssignments[k]||null)}}else{const g=t.tokens.gold||0;m.goldAssignments=Array.from({length:g},()=>null)}const b=[],w=h&&h.color==="wild",T=w?Oe(m.playerId):!0;if(a.length>0&&b.push(`
      <div style="background:#ffffff; color:#222; padding:8px 10px; border-radius:8px; display:block; box-shadow:0 1px 2px rgba(0,0,0,.1);">
        <div style="font-weight:800; margin-bottom:6px;">You have:</div>
        <div style="display:flex; flex-wrap:wrap; align-items:center; gap:4px;">${a.join("")}</div>
      </div>
    `),a.length===0?b.push('<div style="margin-top:8px; color:#ff8a80;">You have no resources to buy this card.</div>'):v?w&&!T&&b.push('<div style="margin-top:8px; color:#ff8a80; font-weight:600;">You must have a non-wild color card to place this on to.</div>'):b.push('<div style="margin-top:8px; color:#ff8a80;">You cannot buy this card with your current resources.</div>'),v&&(t.tokens.gold||0)>0){const g=t.tokens.gold||0,S=g>1?"Use your gold tokens:":"Use your gold token:",k=[],L=D=>D==="pearl"?le(18):ae(D,18);for(let D=0;D<g;D++){const j=m.goldAssignments[D],Me=u.map(Ue=>`<span class="gold-option" data-row="${D}" data-kind="${Ue}" style="display:inline-flex; width:24px; height:24px; margin:2px; align-items:center; justify-content:center; border-radius:6px; cursor:pointer; ${j===Ue?"outline: 2px solid #4a90e2; box-shadow: 0 0 6px rgba(74,144,226,.6); background: rgba(255,255,255,.06);":"opacity:.7;"}">${L(Ue)}</span>`).join("");k.push(`
        <div class="gold-row" data-row="${D}" style="display:flex; align-items:center; gap:8px; margin-top:6px;">
          <span style="display:inline-flex; width:24px; height:24px; align-items:center; justify-content:center;">${Ce(18)}</span>
          <div style="display:flex; flex-wrap:wrap;">${Me}</div>
        </div>
      `)}b.push(`
      <div style="background:#ffffff; color:#222; padding:8px 10px; border-radius:8px; display:block; box-shadow:0 1px 2px rgba(0,0,0,.1); margin-top:10px;">
        <div style="font-weight:800; margin-bottom:6px;">${S}</div>
        ${k.join("")}
      </div>
    `);const P=He(h,m.playerId,m.goldAssignments);P.valid||b.push(`<div style="margin-top:6px; color:#ff8a80;">${P.message}</div>`)}const C=c.currentPlayer===1?"player1":"player2",U=c.players[C].reserves.length;!(m&&m.context&&m.context.fromReserve)&&U>=3&&b.push('<div style="margin-top:10px; color:#ffcc80;">You already have 3 reserved cards and cannot reserve another.</div>'),e.innerHTML=`
    <div style="display:flex; flex-direction:column; gap:6px; padding:8px 8px 8px 28px; box-sizing:border-box;">
      ${b.join("")}
    </div>
  `,document.querySelectorAll(".gold-option").forEach(g=>{g.addEventListener("click",()=>{const S=parseInt(g.getAttribute("data-row"),10),k=g.getAttribute("data-kind");m.goldAssignments[S]===k?m.goldAssignments[S]=null:m.goldAssignments[S]=k,_t()})});const A=document.getElementById("buy-button");if(A){const g=He(h,m.playerId,m.goldAssignments),k=h&&h.color==="wild"?Oe(m.playerId):!0;A.disabled=!g.valid||!k,A.onclick=()=>En()}const O=document.querySelector(".reserve-button");if(O){const g=c.currentPlayer===1?"player1":"player2";if(m&&m.context&&m.context.fromReserve)O.style.display="none";else{const k=Pe(),L=c.players[g].reserves.length<3;O.disabled=!L||!k,O.title=k?L?"":"Cannot reserve: already have 3 reserved cards":"Cannot reserve: no gold on board"}}},lt=(e,t)=>{if(!e)return;const o=t==="player1"?"player2":"player1";if(e.ability==="again"){X("repeat_turn_awarded",{card:Ie(e)}),W=!0,In();return}if(e.ability==="token"){const s=e.color;if(s&&s!=="none"&&s!=="wild"){let l=!1;for(let a=0;a<c.board.length;a++){for(let r=0;r<c.board[a].length;r++)if(c.board[a][r]===s){l=!0;break}if(l)break}if(l){ee=!0,J=s,Pn(!0);return}}}if(e.ability==="steal"){const s=c.players[o];if(["blue","white","green","red","black","pearl"].some(r=>(s.tokens[r]||0)>0)){Tn();return}}W||Q()},In=()=>{const e=document.getElementById("repeat-turn-dialog");if(!e)return;const t=document.querySelector(".game-container");t&&t.classList.add("dialog-blocking"),e.style.display="flex",dt()},Cn=()=>{const e=document.getElementById("repeat-turn-dialog");e&&(e.style.display="none");const t=document.querySelector(".game-container");t&&t.classList.remove("dialog-blocking");const n=c.currentPlayer===1?"player1":"player2";if(We(n)>10){Ft();return}W=!1},Pn=(e=!1)=>{const t=document.getElementById("token-selection-modal");if(!t)return;const n=t.querySelector(".modal-body"),o=document.getElementById("token-modal-layout"),s=o?.querySelector(".token-board-section"),l=t.querySelector(".token-modal-actions");if(e&&n&&o){const a=n.querySelector("#bonus-token-message");a&&a.remove();const r=document.createElement("div");r.id="bonus-token-message";const i=J||"this color";r.innerHTML=`
      <div style="
        background: rgba(74, 144, 226, 0.95);
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        max-width: 200px;
      ">
        <div style="font-size: 1.1em; margin-bottom: 8px;">Bonus Token</div>
        <div style="font-size: 0.9em;">Select ONE ${i} token</div>
      </div>
    `;const d=document.createElement("div");if(d.id="bonus-token-message-section",d.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
    `,d.appendChild(r),o.style.cssText=`
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      width: 100%;
    `,s&&(s.style.cssText=`
        flex: 0 0 auto;
        display: flex;
        justify-content: flex-start;
      `),o.appendChild(d),l){const y=l.querySelector(".btn-cancel"),f=l.querySelector(".btn-refill");y&&(y.style.display="none"),f&&(f.style.display="none")}const u=document.getElementById("scroll-usage-section");u&&(u.style.display="none")}else{if(o){o.style.cssText="";const r=o.querySelector("#bonus-token-message-section");r&&r.remove()}if(s&&(s.style.cssText=""),l){const r=l.querySelector(".btn-cancel"),i=l.querySelector(".btn-refill");r&&(r.style.display=""),i&&(i.style.display="")}const a=document.getElementById("scroll-usage-section");a&&(a.style.display="")}ne(),Te(),Se(),V(),G("token-selection-modal")},Tn=()=>{const t=(c.currentPlayer===1?"player1":"player2")==="player1"?"player2":"player1",n=c.players[t],s=["blue","white","green","red","black","pearl"].filter(r=>(n.tokens[r]||0)>0);if(s.length===0){W||Q();return}const l=`
    <div class="modal-overlay card-modal-overlay" id="steal-token-modal" style="display: flex;">
      <div class="modal-content card-detail-content">
        <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; padding: 24px;">
          <h3 style="margin: 0; color: #333; font-size: 1.3em;">Steal a Token</h3>
          <p style="margin: 0; color: #666; text-align: center;">Select a token color to steal from your opponent:</p>
          <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
            ${s.map(r=>{const i=r==="pearl"?le(40):ae(r,40);return`
                <div class="steal-token-option" data-color="${r}" style="
                  width: 60px;
                  height: 60px;
                  border-radius: 50%;
                  border: 3px solid #333;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                  transition: all 0.2s;
                  background: ${re(r)};
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                ">
                  ${i}
                </div>
              `}).join("")}
          </div>
          <div style="display: flex; gap: 12px; margin-top: 12px;">
            <button class="action-button cancel-button" onclick="closeStealTokenModal()">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  `,a=document.getElementById("steal-token-modal");a&&a.remove(),document.body.insertAdjacentHTML("beforeend",l),document.querySelectorAll(".steal-token-option").forEach(r=>{r.addEventListener("click",()=>{const i=r.getAttribute("data-color");At(i)}),r.addEventListener("mouseenter",()=>{r.style.transform="scale(1.1)",r.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.3)"}),r.addEventListener("mouseleave",()=>{r.style.transform="scale(1)",r.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.2)"})})},Rt=()=>{const e=document.getElementById("steal-token-modal");e&&e.remove(),W||Q()},At=e=>{if(!R("Token stealing abilities resolve on your turn."))return;const t=c.currentPlayer===1?"player1":"player2",n=t==="player1"?"player2":"player1";c.players[n].tokens[e]>0&&(c.players[n].tokens[e]--,c.players[t].tokens[e]++),X("token_stolen",{color:e}),Rt(),I(),W||Q()},En=()=>{if(!R("Purchasing cards is only allowed on your turn.")||!m||!h)return;const{playerId:e}=m;if(!He(h,e,m.goldAssignments).valid)return;if(m&&m.context&&m.context.fromReserve&&m.context&&m.context.reserveIndex,h.ability==="steal"||h.ability==="token"){const o=Ee(e,1);if(o.willExceed){const l=`This card's ability (${h.ability==="steal"?"stealing a token":"taking a bonus token"}) will give you ${o.after} tokens (limit is 10). You'll need to discard ${o.excessCount} token${o.excessCount>1?"s":""} after using the ability.<br><br>Purchase this card?`;he(l,()=>{ft()});return}}ft()},ft=()=>{if(!m||!h)return;const{playerId:e}=m,t=He(h,e,m.goldAssignments);if(!t.valid)return;const n=m&&m.context&&m.context.fromReserve,o=n&&m.context?m.context.reserveIndex:null;if(h.color==="wild"){ue={card:h,fromReserve:m.context&&m.context.fromReserve,reserveIndex:m.context?m.context.reserveIndex:null,playerId:e,paymentPlan:t},m=null,ve=null,z("card-detail-popover"),An();return}const l=c.players[e];if(["gold","pearl",...H].forEach(r=>{const i=t.spend[r]||0;i>0&&(l.tokens[r]=Math.max(0,(l.tokens[r]||0)-i),c.bag[r]=(c.bag[r]||0)+i)}),n)if(typeof o=="number"&&o>=0){const r=c.players[e].reserves.splice(o,1)[0];r&&l.cards.push(r)}else l.cards.push(h);else{const i=`level${h.level}`,d=h._pyramidIndex;l.cards.push(h),c.pyramid[i].splice(d,1),c.decks[i].length>0&&c.pyramid[i].splice(d,0,c.decks[i].shift())}m=null,ve=null,z("card-detail-popover"),I();const a=l.cards[l.cards.length-1];X("card_purchased",{card:Ie(a),fromReserve:!!n,tokensSpent:Ct(t.spend),ability:a.ability||null}),lt(a,e)},Mn=(e,t,n,o,s=!1)=>{const l=t+n;let a="";if(n>0){const v=Math.min(n,4),b=24,w=[];for(let T=0;T<v;T++){const C=ae(e,b);w.push(`<div class="hand-token" style="filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));">${C}</div>`)}a=`<div class="hand-tokens-grid">${w.join("")}</div>`}const r=t===0?'style="border: 2px dashed #ccc; background: transparent;"':"";let i="",d="",u="";if(t>0){const v=re(e),b=me(e);s?(i=`<div class="card-stripe-top ${b}" style="background-color: #999;"></div>`,d=`<div class="card-stripe-bottom ${b}" style="background-color: #999;"></div>`,u=`<div class="wild-token-icon" style="position: absolute; top: 4px; left: 4px; z-index: 15;">${Ne(22)}</div>`):(i=`<div class="card-stripe-top ${b}" style="background-color: ${v}"></div>`,d=`<div class="card-stripe-bottom ${b}" style="background-color: ${v}"></div>`)}const y=t===0?"color-card-empty":"",f=t>0?`<div class="points-value ${e}">${o} pts</div>`:"";return`
    <div class="color-card ${e} ${y}" ${r}>
      ${i}
      ${d}
      ${u}
      ${a}
      <div class="power-circle ${e}">${l}</div>
      ${f}
    </div>
  `},Dt=e=>{const{greyCards:t,royalCards:n}=Sn(e),o=[...t,...n];if(o.length===0)return'<div class="misc-cards-fan-inline"></div>';let l='<div class="misc-cards-fan-inline"><div class="misc-cards-fan-inner" style="width: '+(18+(o.length-1)*10)+'px;">';return o.forEach((a,r)=>{const i=r*10,d=a.id&&a.id.startsWith("royal-"),u=d?"linear-gradient(135deg, #d4af37 0%, #f7e98e 100%)":"#888",y=d?"#b8941c":"#666",f=a.points||0;l+=`
      <div class="misc-card-tiny" style="left: ${i}px; background: ${u}; border-color: ${y};" title="${d?"Royal":"Point"} Card: ${f} pts">
        <span class="misc-card-pts">${f}</span>
      </div>
    `}),l+="</div></div>",l},jt=e=>{const{cards:t,points:n,wildStacks:o}=ie(e),s=c.players[e],l=["blue","white","green","red","black"],a=rt(e),r=s.reserves.length,i=Pe(),d=q||r>=3||!i,u=r>=3?"You already have 3 reserved cards.":i?"Reserve a card.":"Cannot reserve: no gold on the board.";let y=`
    <div class="hand-header-strip">
      <div class="hand-stats-group">
        <div class="hand-stat score">${a.totalPoints}</div>
        <div class="hand-stat crown">${N(14)}<span>${a.totalCrowns}</span></div>
        <div class="hand-stat color-pip ${a.maxColor} ${a.maxPoints===0?"empty":""}"><span>${a.maxPoints}</span></div>
      </div>
      ${Dt(e)}
      <div class="hand-resources-group">
        ${Bt(e,20)}
        <button onclick="enterReserveMode()" class="hand-reserve-btn-compact" ${d?"disabled":""} title="${u}">Reserve</button>
      </div>
    </div>
  `;y+='<div class="color-cards-row">',l.forEach(w=>{const T=t[w]||0,C=s.tokens[w]||0,U=o[w]||!1;y+=Mn(w,T,C,n[w]||0,U)});const f=r===0?"reserved-section-empty":"reserved-section-filled";let v=!1;return r>0&&(v=s.reserves.some(w=>pe(w,e).affordable)),y+=`
    <div class="reserved-section ${f} ${v?"reserved-affordable":""}" id="show-reserved" data-clickable="popover" data-popover="reserved-modal">
      <div class="reserved-count">${r}</div>
      <div class="reserved-label">Reserved</div>
    </div>
  `,y+="</div>",y},qt=()=>{const e=$.opponentPlayerId,{cards:t,points:n}=ie(e),o=c.players[e],s=rt(e),l=["blue","white","green","red","black"];let a="";l.forEach(d=>{const u=t[d]||0,y=o.tokens[d]||0,f=n[d]||0,v=u+y;let b="";if(y>0){const A=Math.min(y,4),O=20,g=[];for(let S=0;S<A;S++){const k=ae(d,O);g.push(`<div class="hand-token" style="filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));">${k}</div>`)}b=`<div class="hand-tokens-grid">${g.join("")}</div>`}let w="",T="";if(u>0){const A=re(d),O=me(d);w=`<div class="card-stripe-top ${O}" style="background-color: ${A}"></div>`,T=`<div class="card-stripe-bottom ${O}" style="background-color: ${A}"></div>`}const C=u===0?"opponent-color-card-empty":"",U=u===0?'style="border: 2px dashed #ccc; background: transparent;"':"",M=u>0?`<div class="opponent-points-value ${d}">${f} pts</div>`:"";a+=`
      <div class="opponent-color-card ${d} ${C}" ${U}>
        ${w}
        ${T}
        ${b}
        <div class="opponent-power-circle ${d}">${v}</div>
        ${M}
      </div>
    `});const r=o.reserves.length,i=r===0?"opponent-reserved-section-empty":"opponent-reserved-section-filled";return`
    <div class="opponent-header-strip">
      <div class="opponent-stats-group">
        <div class="hand-stat score">${s.totalPoints}</div>
        <div class="hand-stat crown">${N(14)}<span>${s.totalCrowns}</span></div>
        <div class="hand-stat color-pip ${s.maxColor} ${s.maxPoints===0?"empty":""}"><span>${s.maxPoints}</span></div>
      </div>
      ${Dt(e)}
      <div class="opponent-resources-group">
        ${Bt(e,20)}
      </div>
    </div>
    <div class="opponent-color-cards-row">
      ${a}
      <div class="opponent-reserved-section ${i}">
        <div class="opponent-reserved-count">${r}</div>
        <div class="opponent-reserved-label">Res</div>
      </div>
    </div>
  `},Ln=()=>{const e=p.sessionId,t=se(e),n=ot(e),o=st(n),s=Ke();return`
    <div class="game-container">
      \x3C!-- Sync Status Indicator and Settings -->
      <div class="sync-controls-bar">
        <div class="sync-status" id="sync-status">
          <span class="sync-indicator" id="sync-indicator" title="Sync status"></span>
          <span class="sync-mode" id="sync-mode">Local</span>
          <span class="sync-session-id" id="sync-session-id" style="display: none;"></span>
          <span class="sync-turn-indicator" id="sync-turn-indicator"></span>
        </div>
        <button class="settings-btn" id="settings-btn" title="Game settings" onclick="window.showSettings()">‚öô</button>
      </div>
      <div class="sync-turn-warning" id="turn-guard-message" aria-live="polite"></div>
      
      \x3C!-- Top Bar: Token Board (left) and Opponent Stats (right) -->
      <div class="top-bar">
        <div class="token-board-container" id="token-board-top">
          <div class="token-board" data-clickable="popover" data-popover="token-selection-modal">
            ${Ve()}
          </div>
        </div>
        <div class="opponent-stats-container" id="opponent-stats">
          ${qt()}
        </div>
      </div>

      \x3C!-- Main Pyramid Area -->
      <div class="pyramid-container">
          \x3C!-- Royal Cards Modal -->
          <div class="modal-overlay card-modal-overlay" id="royal-modal" style="display: none;">
            <div class="modal-content">
              <div class="modal-body" id="royal-modal-body">
                \x3C!-- Content will be populated dynamically -->
              </div>
            </div>
          </div>

          \x3C!-- Card Detail Popover -->
          <div class="modal-overlay card-modal-overlay" id="card-detail-popover" style="display: none;">
            <div class="modal-content card-detail-content">
              <div class="modal-body">
                \x3C!-- Content will go here -->
              </div>
            </div>
          </div>

          \x3C!-- Token Selection Modal -->
          <div class="modal-overlay card-modal-overlay" id="token-selection-modal" style="display: none;">
            <div class="modal-content card-detail-content">
              <div class="modal-body">
                <div class="token-modal-layout" id="token-modal-layout">
                  <div class="token-board-section">
                    <div class="token-board-wrapper">
                      <div class="token-selection-content" id="token-board-container">
                        ${Ve(220)}
                        <div id="token-click-overlays">${Wt()}</div>
                      </div>
                    </div>
                  </div>
                  <div class="scroll-usage-section" id="scroll-usage-section">
                    \x3C!-- Scroll display will be rendered here -->
                  </div>
                </div>
                <div class="token-modal-actions">
                  <button class="btn-cancel" onclick="closePopover('token-selection-modal')">Cancel</button>
                  <button class="btn-confirm" onclick="confirmTokenSelection()">Confirm</button>
                  <button id="refill-board-btn" class="btn-refill" onclick="refillBoard()" title="Refill board from bag">Refill</button>
                </div>
              </div>
            </div>
          </div>

          \x3C!-- Reserved Cards Modal -->
          <div class="modal-overlay card-modal-overlay" id="reserved-modal" style="display: none;">
            <div class="modal-content card-detail-content">
              <div class="modal-body">
                \x3C!-- Content will be injected -->
              </div>
            </div>
          </div>

          \x3C!-- Wild Card Placement Modal -->
          <div class="modal-overlay card-modal-overlay" id="wild-placement-modal" style="display: none;">
            <div class="modal-content card-detail-content">
              <div class="modal-body">
                \x3C!-- Content will be injected -->
              </div>
            </div>
          </div>

          \x3C!-- Turn Completion Dialog -->
          <div class="modal-overlay card-modal-overlay" id="turn-completion-dialog" style="display: none;">
            <div class="modal-content turn-completion-content">
              <div class="turn-completion-message">
                <h3>Your turn has been completed</h3>
                <p>Click below to switch players</p>
              </div>
              <div class="turn-summary-container" id="turn-summary-container" style="display: none;">
                <div class="turn-summary-list" id="turn-summary-list"></div>
              </div>
              <button class="action-button switch-players-button" id="switch-players-btn">Switch Players</button>
            </div>
          </div>

          \x3C!-- Repeat Turn Dialog -->
          <div class="modal-overlay card-modal-overlay" id="repeat-turn-dialog" style="display: none;">
            <div class="modal-content turn-completion-content">
              <div class="turn-completion-message">
                <h3>Repeat Turn!</h3>
                <p>You get another turn. Continue playing!</p>
              </div>
              <button class="action-button switch-players-button" onclick="closeRepeatTurnModal()">Okay</button>
            </div>
          </div>

          \x3C!-- Token Discard Modal -->
          <div class="modal-overlay card-modal-overlay" id="token-discard-modal" style="display: none;">
            <div class="modal-content token-discard-content">
              <div class="token-discard-message" id="token-discard-message">
                \x3C!-- Message will be populated dynamically -->
              </div>
              <div class="token-discard-grid" id="token-discard-grid">
                \x3C!-- Tokens will be populated dynamically -->
              </div>
              <div class="token-discard-actions">
                <button class="btn-minimize" id="minimize-discard-btn" onclick="minimizeDiscardModal()">Minimize</button>
                <button class="btn-confirm" id="confirm-discard-btn" onclick="confirmTokenDiscard()">Confirm</button>
              </div>
            </div>
          </div>

          \x3C!-- Generic Confirmation Modal -->
          <div class="modal-overlay card-modal-overlay" id="confirmation-modal" style="display: none;">
            <div class="modal-content confirmation-content">
              <div class="confirmation-message" id="confirmation-message">
                \x3C!-- Message will be populated dynamically -->
              </div>
              <div class="confirmation-actions">
                <button class="btn-cancel" id="confirmation-cancel-btn">Cancel</button>
                <button class="btn-confirm" id="confirmation-confirm-btn">Confirm</button>
              </div>
            </div>
          </div>

          
          <div class="card-pyramid ${q?"reserve-mode":""}">
            <div class="pyramid-row">
              ${q?`
                <div class="deck-meter-container" data-clickable="reserve-deck" data-deck-level="1">
                  <div class="deck-placeholder">?</div>
                </div>
              `:`
                <div class="deck-meter-container">
                  <div class="deck-meter">
                    <div class="meter-fill level-1" style="height: ${Fe(1)}%"></div>
                  </div>
                </div>
              `}
              ${c.pyramid.level1.map((l,a)=>{l._pyramidIndex=a;const r=pe(l,s),i=q?'data-clickable="reserve-target"':'data-clickable="card" data-popover="card-detail-popover"';return de(l,"level-1-card",r.affordable).replace('data-clickable="card" data-popover="card-detail-popover"',i)}).join("")}
              
              <div class="card-spacer"></div>
              ${(()=>{const l=c.royalCards.filter(d=>!d.taken).length,a=l===0,r=a?"":'data-clickable="popover" data-popover="royal-modal"',i=a?"royal-cards-empty":"";return q?`
                    <div class="reserve-royal-group reserve-mode-active">
                      <div class="reserve-mode-panel">
                        <div class="reserve-mode-title">Select a Card</div>
                        <button onclick="exitReserveMode()" class="action-button cancel-button reserve-mode-cancel">Cancel</button>
                      </div>
                    </div>
                  `:`
                  <div class="royal-cards-summary card-shaped ${i}" id="royal-cards-trigger" ${r}>
                    <div class="royal-card-icon-centered ${a?"royal-icon-greyed":""}">${N(32)}</div>
                    <div class="royal-card-label">${l}</div>
                  </div>
                `})()}
            </div>

            <div class="pyramid-row">
              ${q?`
                <div class="deck-meter-container" data-clickable="reserve-deck" data-deck-level="2">
                  <div class="deck-placeholder">?</div>
                </div>
              `:`
                <div class="deck-meter-container">
                  <div class="deck-meter">
                    <div class="meter-fill level-2" style="height: ${Fe(2)}%"></div>
                  </div>
                </div>
              `}
              ${c.pyramid.level2.map((l,a)=>{l._pyramidIndex=a;const r=pe(l,s),i=q?'data-clickable="reserve-target"':'data-clickable="card" data-popover="card-detail-popover"';return de(l,"level-2-card",r.affordable).replace('data-clickable="card" data-popover="card-detail-popover"',i)}).join("")}
            </div>

            <div class="pyramid-row">
              ${q?`
                <div class="deck-meter-container" data-clickable="reserve-deck" data-deck-level="3">
                  <div class="deck-placeholder">?</div>
                </div>
              `:`
                <div class="deck-meter-container">
                  <div class="deck-meter">
                    <div class="meter-fill level-3" style="height: ${Fe(3)}%"></div>
                  </div>
                </div>
              `}
              ${c.pyramid.level3.map((l,a)=>{l._pyramidIndex=a;const r=pe(l,s),i=q?'data-clickable="reserve-target"':'data-clickable="card" data-popover="card-detail-popover"';return de(l,"level-3-card",r.affordable).replace('data-clickable="card" data-popover="card-detail-popover"',i)}).join("")}
              <div class="card-spacer"></div>
              <div class="card-spacer"></div>
            </div>
          </div>
        </div>


      \x3C!-- Global Hand Display (always at bottom) -->
      <div class="global-hand-display" id="player-hand">
        ${jt($.activePlayerId)}
      </div>

      \x3C!-- Mode Selection Modal -->
      <div class="modal-overlay card-modal-overlay" id="mode-selection-modal" style="display: none;">
        <div class="modal-content turn-completion-content">
          <div class="turn-completion-message">
            <h3>Choose Game Mode</h3>
            <p>How would you like to play?</p>
          </div>
          <div class="mode-selection-buttons">
            <button class="action-button" onclick="window.selectLocalMode()">Local Hotseat</button>
            <button class="action-button" onclick="window.hostOnlineGame()">Online ‚Äì Host New Game</button>
            <button class="action-button" onclick="window.showJoinDialog()">Online ‚Äì Join Game</button>
          </div>
          <div style="margin-top: 15px; text-align: center;">
            <button class="btn-cancel" onclick="window.closeModeSelection()" style="font-size: 12px; padding: 6px 12px;">Close</button>
          </div>
        </div>
      </div>

      \x3C!-- Join Game Modal -->
      <div class="modal-overlay card-modal-overlay" id="join-game-modal" style="display: none;">
        <div class="modal-content turn-completion-content">
          <div class="turn-completion-message">
            <h3>Join Online Game</h3>
            <p>Enter the session ID to join:</p>
            <input type="text" id="join-session-input" placeholder="Session ID" style="width: 100%; padding: 8px; margin: 10px 0; font-size: 14px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px;">
            <p style="font-size: 12px; color: #666; margin-top: 5px;">Warning: This will replace your current game state.</p>
          </div>
          <div class="mode-selection-buttons">
            <button class="action-button" onclick="window.confirmJoinGame()">Join</button>
          </div>
          <div style="margin-top: 10px; text-align: center;">
            <button class="btn-cancel" onclick="window.closeJoinDialog()" style="font-size: 12px; padding: 6px 12px;">Cancel</button>
          </div>
        </div>
      </div>

      \x3C!-- Settings Modal -->
      <div class="modal-overlay card-modal-overlay" id="settings-modal" style="display: none;">
        <div class="modal-content turn-completion-content">
          <div class="turn-completion-message">
            <h3>Game Settings</h3>
            <div id="settings-content">
              \x3C!-- Content populated dynamically -->
            </div>
          </div>
          <div style="margin-top: 15px; text-align: center;">
            <button class="btn-cancel" onclick="window.closeSettings()" style="font-size: 12px; padding: 6px 12px;">Close</button>
          </div>
        </div>
      </div>

      \x3C!-- Session Info Modal (for host) -->
      <div class="modal-overlay card-modal-overlay" id="session-info-modal" style="display: none;">
        <div class="modal-content turn-completion-content">
          <div class="turn-completion-message">
            <h3>Game Session Created</h3>
            <p>Share this session ID with your opponent:</p>
            <div class="session-id-display" id="session-id-display">${t||""}</div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">Or share this link:</p>
            <div class="session-link-display" id="session-link-display">${n||""}</div>
            <div class="qr-wrapper" id="session-qr-wrapper">
              <img id="session-qr-image" src="${o||""}" alt="Session QR code" style="${o?"":"display:none;"}" />
            </div>
            <button class="action-button" onclick="window.copySessionInfo()" style="margin-top: 10px; width: 100%;">Copy Link</button>
          </div>
          <div style="margin-top: 15px; text-align: center;">
            <button class="btn-cancel" onclick="window.closeSessionInfo()" style="font-size: 12px; padding: 6px 12px;">Start Game</button>
          </div>
        </div>
      </div>
  </div>
  `};let h=null,ve=null,ue=null,mt=!1;const Bn=()=>{mt||(document.addEventListener("click",e=>{e.target.closest("#show-reserved")&&(e.preventDefault(),G("reserved-modal"))}),mt=!0)},G=(e,t=null,n=null)=>{const o=document.getElementById(e);if(o){if(oe&&e!=="royal-modal")return;_n(e),e==="card-detail-popover"&&t?(h=t,qn(t)):e==="reserved-modal"?Rn():e==="royal-modal"&&at(oe),o.style.display="flex"}},z=e=>{const t=document.getElementById(e);if(t&&(t.style.display="none"),e==="card-detail-popover"&&(h=null),e==="token-selection-modal"){x=[],Ge(),K=!1,_=null,xe=!1,ee=!1,J=null;const n=document.getElementById("token-selection-modal");if(n){const o=n.querySelector("#bonus-token-message");o&&o.remove();const s=n.querySelector("#bonus-token-message-section");s&&s.remove();const l=document.getElementById("token-modal-layout");l&&(l.style.cssText="");const a=l?.querySelector(".token-board-section");a&&(a.style.cssText="");const r=n.querySelector(".token-modal-actions");if(r){const d=r.querySelector(".btn-cancel"),u=r.querySelector(".btn-refill");d&&(d.style.display=""),u&&(u.style.display="")}const i=document.getElementById("scroll-usage-section");i&&(i.style.display="")}}if(e==="wild-placement-modal"&&(ue=null),e==="royal-modal"&&!oe){const n=document.querySelector(".game-container");n&&n.classList.remove("dialog-blocking")}},_n=e=>{document.querySelectorAll(".modal-overlay").forEach(n=>{const o=n.id;o&&o!==e&&n.style.display!=="none"&&z(o)})},Rn=()=>{const e=document.querySelector("#reserved-modal .modal-body");if(!e)return;const t=p.enabled&&p.localPlayerId?p.localPlayerId:Ke(),n=c.players[t].reserves||[];if(n.length===0){e.innerHTML=`
      <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:20px;">
        <div style="color:#ddd; font-style:italic;">You have no reserved cards.</div>
        <button onclick="closePopover('reserved-modal')" class="action-button cancel-button">Close</button>
      </div>
    `;return}const o=n.map((s,l)=>{const a=pe(s,t),i=s.color==="wild"?Oe(t):!0,d=a.affordable&&i;return`
      <div class="reserved-card-wrapper" style="flex:0 0 30%; max-width:30%; display:flex; flex-direction:column; align-items:center; gap:10px; padding-bottom:14px;">
        <div style="display:flex; justify-content:center; align-items:center; transform: scale(1.4); transform-origin: top center; margin-bottom:30px;">
          ${de(s,`level-${s.level}-card`)}
        </div>
        <button class="action-button buy-button" ${d?"":"disabled"} data-reserve-index="${l}">Buy</button>
      </div>
    `}).join("");e.innerHTML=`
    <div style="display:flex; flex-direction:column; gap:12px; padding:12px; height:100%; box-sizing:border-box;">
      <div style="display:flex; justify-content:center; gap:16px; align-items:flex-start; flex-wrap:nowrap; width:100%;">
        ${o}
      </div>
      <div style="display:flex; justify-content:center; margin-top:auto;">
        <button onclick="closePopover('reserved-modal')" class="action-button cancel-button">Close</button>
      </div>
    </div>
  `,e.querySelectorAll(".buy-button").forEach(s=>{s.addEventListener("click",()=>{const l=parseInt(s.getAttribute("data-reserve-index"),10),a=n[l];a&&(ve={source:"reserve",reserveIndex:l,playerId:t},z("reserved-modal"),G("card-detail-popover",a,null))})})},An=()=>{if(!ue)return;const e=document.querySelector("#wild-placement-modal .modal-body");if(!e)return;const{playerId:t}=ue,{cards:n,wildStacks:o}=ie(t),l=["blue","white","green","red","black"].filter(r=>!((n[r]||0)===0||o[r]));if(l.length===0){e.innerHTML=`
      <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:20px; padding:20px;">
        <div style="color:#ff8a80; font-weight:600; text-align:center;">
          You must have a non-wild color card to place this on to.
        </div>
        <button onclick="closePopover('wild-placement-modal'); pendingWildCard = null;" class="action-button cancel-button">Close</button>
      </div>
    `,G("wild-placement-modal");return}const a=l.map(r=>{const i=n[r]||0,d=re(r),u=r.charAt(0).toUpperCase()+r.slice(1);return`
      <div class="wild-color-option" data-color="${r}" style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 16px;
        border: 2px solid ${d};
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
      ">
        <div style="
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: ${d};
          border: 3px solid #333;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.5em;
          font-weight: bold;
          color: white;
          text-shadow: 0 0 3px rgba(0,0,0,0.5);
        ">${i}</div>
        <div style="font-weight: 600; color: #333;">${u}</div>
      </div>
    `}).join("");e.innerHTML=`
    <div style="display:flex; flex-direction:column; gap:20px; padding:20px; height:100%; box-sizing:border-box;">
      <div style="text-align:center;">
        <h3 style="margin-bottom:8px; color:#f5f5f5;">Select a Color Stack</h3>
        <p style="color:#e0e6ff; font-size:0.9em;">Choose which color stack to place this wild card in</p>
      </div>
      <div style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; flex:1; align-items:center;">
        ${a}
      </div>
      <div style="display:flex; justify-content:center; margin-top:auto;">
        <button onclick="closePopover('wild-placement-modal'); pendingWildCard = null;" class="action-button cancel-button">Cancel</button>
      </div>
    </div>
  `,e.querySelectorAll(".wild-color-option").forEach(r=>{r.addEventListener("click",()=>{const i=r.getAttribute("data-color");Dn(i)}),r.addEventListener("mouseenter",()=>{r.style.transform="scale(1.05)",r.style.boxShadow="0 4px 12px rgba(0,0,0,0.2)"}),r.addEventListener("mouseleave",()=>{r.style.transform="scale(1)",r.style.boxShadow="none"})}),G("wild-placement-modal")},Dn=e=>{if(!ue)return;const{card:t,fromReserve:n,reserveIndex:o,playerId:s,paymentPlan:l}=ue,a=c.players[s];if(l&&["gold","pearl",...H].forEach(i=>{const d=l.spend[i]||0;d>0&&(a.tokens[i]=Math.max(0,(a.tokens[i]||0)-d),c.bag[i]=(c.bag[i]||0)+d)}),t.wildColorStack=e,n&&typeof o=="number"&&o>=0){const i=a.reserves.splice(o,1)[0];i&&(i.wildColorStack=e,a.cards.push(i))}else{const d=`level${t.level}`,u=t._pyramidIndex;a.cards.push(t),c.pyramid[d].splice(u,1),c.decks[d].length>0&&c.pyramid[d].splice(u,0,c.decks[d].shift())}ue=null,z("wild-placement-modal"),I();const r=a.cards[a.cards.length-1];lt(r,s)},jn=()=>{oe=!0,Y=null;const e=document.querySelector(".game-container");e&&e.classList.add("dialog-blocking"),at(!0),G("royal-modal")},at=(e=!1)=>{const t=document.querySelector("#royal-modal-body");if(!t)return;const n=c.royalCards.filter(r=>!r.taken),o=n.length,s=c.royalCards;if(e){const r=s.map((d,u)=>{if(d.taken)return'<div class="royal-card-view royal-card-empty"></div>';const y=d.ability?Je({ability:d.ability}):"",v=Y&&Y.id===d.id?"royal-card-selected":"";return`
        <div class="royal-card-view royal-card-clickable" data-card-id="${d.id}">
          <div class="card royal-card-large ${v}" onclick="selectRoyalCard('${d.id}')" style="cursor: pointer;">
            \x3C!-- Gold arch background in upper right -->
            <div class="royal-card-arch"></div>
            
            \x3C!-- Darker gold arch in upper right (smaller, higher) -->
            <div class="royal-card-arch-dark"></div>
            
            \x3C!-- Gold bottom stripe -->
            <div class="royal-card-stripe-bottom"></div>
            
            \x3C!-- Points in upper left -->
            <div class="royal-card-points">${d.points}</div>
            
            \x3C!-- Ability icon in upper right -->
            ${d.ability?`<div class="royal-card-ability">${y}</div>`:""}
            
            \x3C!-- Crown in center -->
            <div class="royal-card-crown">${N(40)}</div>
          </div>
        </div>
      `}).join(""),i=Y?"":"disabled";t.innerHTML=`
      <div style="display: flex; flex-direction: row; height: 100%; padding: 10px; box-sizing: border-box; gap: 10px;">
        <div class="royal-cards-view royal-grid-4" style="flex: 1; height: 100%; align-items: center; justify-content: center;">
          ${r}
        </div>
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: space-between; flex-shrink: 0; width: 120px; padding: 10px 0;">
          <div style="text-align: center; font-size: 0.95em; color: #f0f0f0; font-weight: 500; line-height: 1.4; margin-bottom: 20px;">
            You've earned a royal card! Select one to add to your hand.
          </div>
          <button onclick="confirmRoyalCardSelection()" class="action-button cancel-button" ${i} style="${i?"opacity: 0.5; cursor: not-allowed;":""}">Confirm</button>
        </div>
      </div>
    `;return}if(o===0){t.innerHTML=`
      <div style="display: flex; flex-direction: column; height: 100%; padding: 10px; box-sizing: border-box;">
        <div style="display: flex; justify-content: center; align-items: center; flex: 1; margin-bottom: 10px;">
          <div style="text-align: center; color: #666;">
            <div style="font-size: 1.2em; margin-bottom: 10px;">No Royal Cards Available</div>
            <div style="font-size: 0.9em;">All royal cards have been taken.</div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center; padding-top: 6px; margin-top: auto;">
          <button onclick="closePopover('royal-modal')" class="action-button cancel-button">Close</button>
        </div>
      </div>
    `;return}let l="";o===4?l="royal-grid-4":o===3?l="royal-grid-3":o===2?l="royal-grid-2":l="royal-grid-1";const a=n.map(r=>{const i=r.ability?Je({ability:r.ability}):"";return`
      <div class="royal-card-view">
        <div class="card royal-card-large">
          \x3C!-- Gold arch background in upper right -->
          <div class="royal-card-arch"></div>
          
          \x3C!-- Darker gold arch in upper right (smaller, higher) -->
          <div class="royal-card-arch-dark"></div>
          
          \x3C!-- Gold bottom stripe -->
          <div class="royal-card-stripe-bottom"></div>
          
          \x3C!-- Points in upper left -->
          <div class="royal-card-points">${r.points}</div>
          
          \x3C!-- Ability icon in upper right -->
          ${r.ability?`<div class="royal-card-ability">${i}</div>`:""}
          
          \x3C!-- Crown in center -->
          <div class="royal-card-crown">${N(40)}</div>
        </div>
      </div>
    `}).join("");t.innerHTML=`
    <div style="display: flex; flex-direction: row; height: 100%; padding: 10px; box-sizing: border-box; gap: 10px;">
      <div class="royal-cards-view ${l}" style="flex: 1; height: 100%; align-items: center; justify-content: center;">
        ${a}
      </div>
      <div style="display: flex; align-items: flex-end; justify-content: center; flex-shrink: 0; width: 100px;">
        <button onclick="closePopover('royal-modal')" class="action-button cancel-button">Close</button>
      </div>
    </div>
  `},qn=e=>{const t=document.querySelector("#card-detail-popover .modal-body");if(!t)return;const n=`level-${e.level}-card`,o=de(e,n).replace("card-v2","card-v2"),s=c.currentPlayer===1?"player1":"player2",l=pe(e,s),r=e.color==="wild"?Oe(s):!0,i=l.affordable&&r,d=ve&&ve.source==="reserve";t.innerHTML=`
    <div style="display:flex; flex-direction:column; gap:10px; padding:12px; height:100%; box-sizing:border-box; position:relative;">
      
      <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start; flex:1 1 auto; overflow:hidden;">
        <div style="display:flex; justify-content:center; align-items:center; transform: scale(2); transform-origin: top left; position: relative; z-index: 1;">
          ${o}
        </div>
        <div id="payment-pane-wrapper" style="flex:1 1 260px; min-width:260px; margin-left:24px; height:100%; overflow:auto; position:relative; z-index:2;">
          <div id="payment-pane"></div>
        </div>
      </div>
      <div style="display:flex; gap:10px; justify-content:center; padding-top:6px; margin-top:auto;">
        <button id="buy-button" class="action-button buy-button" ${i?"":"disabled"}>Buy</button>
        <button onclick="closePopover('card-detail-popover')" class="action-button cancel-button">Close</button>
      </div>
    </div>
  `;const u=s,y=$n(e,u);m={playerId:u,selection:y.selection,caps:y.caps,context:{fromReserve:d,reserveIndex:d?ve.reserveIndex:null}},_t()},On=()=>{if(!R("Buying cards is only allowed on your turn.")||!h)return;const t=`level${h.level}`,n=h._pyramidIndex,o=c.currentPlayer===1?"player1":"player2";c.players[o].cards.push(h),c.pyramid[t].splice(n,1),c.decks[t].length>0&&c.pyramid[t].splice(n,0,c.decks[t].shift()),z("card-detail-popover"),I()},Pe=()=>{for(let e=0;e<c.board.length;e++)for(let t=0;t<c.board[e].length;t++)if(c.board[e][t]==="gold")return!0;return!1},Ot=e=>{const t=[];for(let n=0;n<c.board.length;n++)for(let o=0;o<c.board[n].length;o++)c.board[n][o]==="gold"&&t.push([n,o]);if(t.length>0){const[n,o]=t[Math.floor(Math.random()*t.length)];return c.board[n][o]=null,e.tokens.gold=(e.tokens.gold||0)+1,!0}return!1},Hn=()=>{if(!R("Reserving cards is only allowed on your turn.")||!h)return;const e=$e();if(c.players[e].reserves.length>=3)return;if(!Pe()){alert("You cannot reserve a card when there is no gold on the board.");return}const n=Ee(e,1);if(n.willExceed){const o=`Reserving this card will give you ${n.after} tokens (limit is 10). You'll need to discard ${n.excessCount} token${n.excessCount>1?"s":""} after this action.<br><br>Continue?`;he(o,()=>{vt()});return}vt()},vt=()=>{const e=$e(),t=c.players[e];q=!1;const n=h?{...h}:null,s=`level${h.level}`,l=h._pyramidIndex;t.reserves.push(h);const a=Ot(t);c.pyramid[s].splice(l,1),c.decks[s].length>0&&c.pyramid[s].splice(l,0,c.decks[s].shift()),z("card-detail-popover"),X("card_reserved",{card:n?Ie(n):null,goldAwarded:a,source:"pyramid"}),I(),Q()};let Le=null;const Gn=e=>{if(!R("Reserving cards is only allowed on your turn."))return;const t=$e();if(c.players[t].reserves.length>=3){alert("You already have 3 reserved cards and cannot reserve another.");return}if(!Pe()){alert("You cannot reserve a card when there is no gold on the board.");return}const o=Ee(t,1);if(o.willExceed){Le=e;const s=`Reserving this card will give you ${o.after} tokens (limit is 10). You'll need to discard ${o.excessCount} token${o.excessCount>1?"s":""} after this action.<br><br>Continue?`;he(s,()=>{gt(Le),Le=null},()=>{Le=null});return}gt(e)},gt=e=>{const t=$e(),n=c.players[t];q=!1;const o=`level${e}`;if(c.decks[o].length===0){alert(`The level ${e} deck is empty.`);return}const s=c.decks[o].shift();n.reserves.push(s);const l=Ot(n);z("card-detail-popover"),X("card_reserved",{card:Ie(s),goldAwarded:l,source:"deck",level:e}),zt(s)};let q=!1;const zn=()=>{if(!R("Reserving cards is only allowed on your turn."))return;const e=$e();if(c.players[e].reserves.length>=3){alert("You already have 3 reserved cards and cannot reserve another.");return}if(!Pe()){alert("You cannot reserve a card when there is no gold on the board.");return}q=!0,I()},Nn=()=>{q=!1,I()},Ht=e=>{h=e;const t=document.querySelector("#card-detail-popover .modal-body");if(t){const n=de(e,`level-${e.level}-card`);t.innerHTML=`
      <div class="reserve-confirm-modal">
        <h3>Reserve this card?</h3>
        <div class="reserve-confirm-card-wrapper">
          <div class="reserve-confirm-card-container">
            ${n}
          </div>
        </div>
        <div class="reserve-confirm-actions">
          <button onclick="reserveSelectedCard()" class="action-button reserve-button">Confirm Reserve</button>
          <button onclick="closePopover('card-detail-popover')" class="action-button cancel-button">Cancel</button>
        </div>
      </div>
    `,G("card-detail-popover")}},Gt=e=>{const t=document.querySelector("#card-detail-popover .modal-body");t&&(t.innerHTML=`
      <div class="reserve-confirm-modal">
        <h3 class="reserve-confirm-title">Reserve from Level ${e} Deck?</h3>
        <div class="reserve-confirm-card-wrapper">
          <div class="reserve-confirm-card-container">
            <div class="face-down-card">?</div>
          </div>
        </div>
        <div class="reserve-confirm-actions">
          <button onclick="reserveFromDeck(${e})" class="action-button reserve-button">Confirm Reserve</button>
          <button onclick="closePopover('card-detail-popover')" class="action-button cancel-button">Cancel</button>
        </div>
      </div>
    `,G("card-detail-popover"))},Wn=()=>{z("card-detail-popover"),setTimeout(()=>{I(),setTimeout(()=>Q(),50)},50)},zt=e=>{const t=document.querySelector("#card-detail-popover .modal-body");if(t){const n=de(e,`level-${e.level}-card`);t.innerHTML=`
      <div class="reserve-confirm-modal">
        <h3 class="reserve-confirm-title">You Reserved</h3>
        <div class="reserve-confirm-card-wrapper">
          <div class="reserve-confirm-card-container">
            ${n}
          </div>
        </div>
        <div class="reserve-confirm-actions">
          <button onclick="handleReserveRevealContinue()" class="action-button reserve-button">Continue</button>
        </div>
      </div>
    `,G("card-detail-popover")}else I(),Q()};let x=[],K=!1,_=null,xe=!1;const Un=(e,t)=>{if(!R("Token selection is only available on your turn."))return;const n=c.board[e][t];if(n==="gold"||!n)return;if(K){_={row:e,col:t,token:n},V(),ne();return}if(ee){const s=x.findIndex(l=>l.row===e&&l.col===t);if(s!==-1)x.splice(s,1);else{if(n!==J){Nt(`You must select a ${J} token`);return}x=[{row:e,col:t,token:n}]}Ge(),ne();return}const o=x.findIndex(s=>s.row===e&&s.col===t);o!==-1?x.splice(o,1):x.push({row:e,col:t,token:n}),Ge(),ne()},Yn=()=>{if(ee){if(x.length===0)return{valid:!1,message:`You must select ONE ${J} token`};if(x.length>1)return{valid:!1,message:"You can only select ONE token as bonus"};const o=x[0];return c.board[o.row][o.col]!==J?{valid:!1,message:`You must select a ${J} token`}:{valid:!0}}if(x.length===0||x.length>3)return{valid:!1,message:"You must select between 1 and 3 tokens"};if(x.length===1)return{valid:!0};const e=x.map(o=>[o.row,o.col]);if(new Set(e.map(o=>o[0])).size===1&&x.length===2){const o=e.map(s=>s[1]).sort((s,l)=>s-l);if(o[1]-o[0]===1)return fe(e)}if(new Set(e.map(o=>o[1])).size===1&&x.length===2){const o=e.map(s=>s[0]).sort((s,l)=>s-l);if(o[1]-o[0]===1)return fe(e)}if(x.length===2){const o=Math.abs(e[0][0]-e[1][0]),s=Math.abs(e[0][1]-e[1][1]);if(o===1&&s===1)return fe(e)}if(x.length===3){if(e.sort((r,i)=>r[0]!==i[0]?r[0]-i[0]:r[1]-i[1]),e.every(r=>r[0]===e[0][0])&&e[2][1]-e[0][1]===2||e.every(r=>r[1]===e[0][1])&&e[2][0]-e[0][0]===2)return fe(e);const l=e[2][0]-e[0][0],a=e[2][1]-e[0][1];if(Math.abs(l)===2&&Math.abs(a)===2&&Math.abs(l)===Math.abs(a))return fe(e)}return{valid:!1,message:"Tokens must be adjacent and in a straight line"}},fe=e=>{for(const[t,n]of e){const o=c.board[t][n];if(!o||o==="gold")return{valid:!1,message:"A straight line of tokens may not include gold tokens or empty spaces"}}return{valid:!0}},Nt=e=>{const t=document.getElementById("token-selection-modal");if(!t)return;let n=document.getElementById("token-selection-error");if(!n){n=document.createElement("div"),n.id="token-selection-error",n.style.cssText=`
      position: absolute;
      top: -80px;
      left: 50%;
      transform: translateX(-50%);
      background: #e74c3c;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      white-space: nowrap;
      z-index: 130;
      font-weight: bold;
      animation: slideIn 0.2s ease;
    `;const o=document.createElement("style");o.textContent=`
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
    `,document.head.appendChild(o),t.parentElement.style.position="relative",t.parentElement.appendChild(n)}n.textContent=e,n.style.display="block"},Ge=()=>{const e=document.getElementById("token-selection-error");e&&(e.style.display="none")},Wt=()=>{let l="";for(let a=0;a<5;a++)for(let r=0;r<5;r++){const i=c.board[a][r],d=x.some(C=>C.row===a&&C.col===r),u=K&&_&&_.row===a&&_.col===r,y=i==="gold",f=!i,v=6.6+r*41.36,b=6.6+a*41.36;let w="token-overlay";d&&(w+=" selected"),u&&(w+=" scroll-selected"),y&&(w+=" gold-token"),f&&(w+=" empty"),l+=`<div class="${w}" 
                     data-row="${a}" 
                     data-col="${r}"
                     style="position: absolute; 
                            left: ${v}px; 
                            top: ${b}px; 
                            width: ${41.36}px; 
                            height: ${41.36}px;
                            cursor: ${y||f?"default":"pointer"};"></div>`}return l},ne=()=>{const e=document.getElementById("token-board-container");if(e){const t=e.querySelector(".token-board-svg");t&&(t.outerHTML=Ve(220));const n=document.getElementById("token-click-overlays");n&&(n.innerHTML=Wt());const o=document.querySelector(".token-modal-actions");o&&(o.style.display=K?"none":"flex"),Te(),V()}},Te=()=>{document.querySelectorAll(".token-overlay").forEach(n=>{const o=n._clickHandler;o&&n.removeEventListener("click",o)}),document.querySelectorAll(".token-overlay").forEach(n=>{const o=s=>{const l=parseInt(n.dataset.row),a=parseInt(n.dataset.col);Un(l,a)};n._clickHandler=o,n.addEventListener("click",o)})},Fn=()=>{if(!R("Token selection is only available on your turn.")||K)return;const e=Yn();if(!e.valid){Nt(e.message);return}const t=c.currentPlayer===1?"player1":"player2",n=Ee(t,x.length);if(n.willExceed){const o=`This will give you ${n.after} tokens (limit is 10). You'll need to discard ${n.excessCount} token${n.excessCount>1?"s":""} after this action.<br><br>Continue?`;he(o,()=>{ht()});return}ht()},ht=()=>{const e=c.currentPlayer===1?"player1":"player2",t=e==="player1"?"player2":"player1",n=x.map(({token:r})=>r);let o=null;const s=[];let l=0;if(x.forEach(({token:r})=>{c.players[e].tokens[r]++,r==="pearl"&&l++}),x.length===3){const r=x.map(({token:i})=>i).filter(i=>i!=="gold");r.length===3&&r.every(i=>i===r[0])&&(we(t),o=t,s.push("three_match"))}l===2&&(we(t),o=t,s.push("two_pearls")),x.forEach(({row:r,col:i})=>{c.board[r][i]=null}),x=[];const a=It(n);if(a.length>0&&X(ee?"bonus_token_collected":"tokens_taken",{tokens:a,scrollAwardedTo:o,scrollReasons:s,bonusColor:ee?J:null}),z("token-selection-modal"),ee){ee=!1,J=null;const r=document.getElementById("token-selection-modal");if(r){const i=r.querySelector("#bonus-token-message");i&&i.remove();const d=r.querySelector("#bonus-token-message-section");d&&d.remove();const u=document.getElementById("token-modal-layout");u&&(u.style.cssText="");const y=u?.querySelector(".token-board-section");y&&(y.style.cssText="");const f=r.querySelector(".token-modal-actions");if(f){const b=f.querySelector(".btn-cancel"),w=f.querySelector(".btn-refill");b&&(b.style.display=""),w&&(w.style.display="")}const v=document.getElementById("scroll-usage-section");v&&(v.style.display="")}}I(),W||Q()},Jn=()=>Pt(5),Ut=()=>Object.values(c.bag).every(e=>e===0),Vn=()=>{const e=[];return Object.keys(c.bag).forEach(t=>{for(let n=0;n<(c.bag[t]||0);n++)e.push(t)}),e},Xn=e=>{const t=[...e];for(let n=t.length-1;n>0;n--){const o=Math.floor(Math.random()*(n+1));[t[n],t[o]]=[t[o],t[n]]}return t},Kn=()=>{R("Refilling the board is only possible on your turn.")&&(Ut()||he("Are you sure you want to refill the board?<br><br>Your opponent will receive a scroll.",()=>{Qn()}))},Qn=()=>{const e=Vn(),t=Xn(e),n=Jn();Object.keys(c.bag).forEach(i=>{c.bag[i]=0});let o=0;for(const[i,d]of n)!c.board[i][d]&&o<t.length&&(c.board[i][d]=t[o],o++);const l=(c.currentPlayer===1?"player1":"player2")==="player1"?"player2":"player1";we(l),X("board_refilled",{tokensPlaced:o,scrollAwardedTo:l}),xe=!0;const a=document.getElementById("token-selection-modal"),r=a&&a.style.display==="flex";r&&(ne(),Se(),V()),I(),r&&setTimeout(()=>{const i=document.getElementById("token-selection-modal");i&&(i.style.display="flex",Te(),Se(),V())},10)},V=()=>{const e=document.getElementById("scroll-usage-section"),t=document.getElementById("token-modal-layout");if(!e||!t)return;const n=c.currentPlayer===1?"player1":"player2",s=c.players[n].privileges||0,l=s>0;if(t.classList.toggle("has-scrolls",l),!l){e.innerHTML="",e.style.display="none";return}if(e.style.display="flex",K){let a='<div class="scroll-selection-mode">';a+='<div class="scroll-selection-label">Choose your token</div>',_&&(a+='<button class="btn-confirm-scroll" id="confirm-scroll-btn" onclick="confirmScrollSelection()">Confirm</button>'),a+='<button class="btn-cancel-scroll" onclick="cancelScrollSelection()">Cancel</button>',a+="</div>",e.innerHTML=a}else{let a='<div class="scroll-display-container">';a+='<div class="scroll-display-label">Use a scroll:</div>',a+='<div class="scroll-icons-container">';const r=s>2?24:28;for(let i=0;i<s;i++){const d=xe?"disabled":"";a+=`<div class="scroll-icon ${d}" data-scroll-index="${i}" onclick="${d?"":"enterScrollSelectionMode()"}">`,a+=`<span class="privilege-scroll-emoji" style="font-size: ${r}px;">üóûÔ∏è</span>`,a+="</div>"}a+="</div>",xe&&(a+='<div class="scroll-disabled-message">You may not use scrolls after refilling the board</div>'),a+="</div>",e.innerHTML=a}},Zn=()=>{R("Scrolls can only be used during your turn.")&&(K=!0,_=null,x=[],Ge(),V(),ne())},eo=()=>{K=!1,_=null,V(),ne()},to=()=>{if(!R("Scrolls can only be used during your turn.")||!_)return;const e=c.currentPlayer===1?"player1":"player2",t=Ee(e,1);if(t.willExceed){const n=`Using this scroll will give you ${t.after} tokens (limit is 10). You'll need to discard ${t.excessCount} token${t.excessCount>1?"s":""} after this action.<br><br>Continue?`;he(n,()=>{bt()});return}bt()},bt=()=>{const e=c.currentPlayer===1?"player1":"player2",t=c.players[e];t.tokens[_.token]++,c.board[_.row][_.col]=null,t.privileges=Math.max(0,(t.privileges||0)-1),X("scroll_token",{token:_.token}),_=null,K=!1,ne(),V();const n=document.getElementById("token-selection-modal"),o=n&&n.style.display==="flex";I(),o&&setTimeout(()=>{const s=document.getElementById("token-selection-modal");s&&(s.style.display="flex",Te(),Se(),V())},10)},Se=()=>{const e=document.getElementById("refill-board-btn");e&&(e.disabled=Ut())},no=e=>{if(!R("Only the active player can claim a royal card.")||!oe)return;const t=c.royalCards.find(o=>o.id===e&&!o.taken);if(!t)return;Y=t,at(!0);const n=document.querySelector("#royal-modal-body button");n&&(n.disabled=!1,n.style.opacity="1",n.style.cursor="pointer")},oo=()=>{if(!R("Only the active player can confirm a royal card.")||!oe||!Y)return;const e=c.currentPlayer===1?"player1":"player2",t=c.players[e],n={...Y,level:3,color:"none",crowns:0,costs:{}};t.cards.push(n),Y.ability==="scroll"&&we(e),Y.taken=!0,X("royal_acquired",{card:Ie(n)}),Y=null,oe=!1;const o=document.querySelector(".game-container");o&&o.classList.remove("dialog-blocking"),z("royal-modal"),I(),lt(n,e)};window.buySelectedCard=On;window.reserveSelectedCard=Hn;window.reserveFromDeck=Gn;window.enterReserveMode=zn;window.exitReserveMode=Nn;window.confirmReserveFromPyramid=Ht;window.confirmReserveFromDeck=Gt;window.showReservedCardReveal=zt;window.handleReserveRevealContinue=Wn;window.confirmTokenSelection=Fn;window.refillBoard=Kn;window.enterScrollSelectionMode=Zn;window.cancelScrollSelection=eo;window.closePopover=z;window.confirmScrollSelection=to;window.selectRoyalCard=no;window.confirmRoyalCardSelection=oo;window.closeStealTokenModal=Rt;window.confirmStealToken=At;window.closeRepeatTurnModal=Cn;document.addEventListener("keydown",e=>{e.key==="Escape"&&document.querySelectorAll(".modal-overlay[style*='flex']").forEach(n=>{n.id!=="turn-completion-dialog"&&n.id!=="repeat-turn-dialog"&&n.id!=="token-discard-modal"&&!(n.id==="royal-modal"&&oe)&&(n.style.display="none")})});const We=e=>{const t=c.players[e];return["blue","white","green","black","red","pearl","gold"].reduce((o,s)=>o+(t.tokens[s]||0),0)},Ee=(e,t)=>{const n=We(e),o=n+t,s=o>10,l=s?o-10:0;return{willExceed:s,current:n,after:o,excessCount:l}},Q=()=>{const e=c.currentPlayer===1?"player1":"player2",n=rt(e).totalCrowns,o=te[e],s=o<3&&n>=3&&n<=5||o>=3&&o<=5&&n>=6;if(We(e)>10){Ft();return}if(s)te[e]=n,jn();else{te[e]=n;const a=p.enabled?"online_end":"local_end";it(a)}},it=(e=p.enabled?"online_end":"local_end")=>{if(e!=="online_start"&&W){W=!1;return}e==="online_start"&&fn(),Qe=e;const t=document.getElementById("turn-completion-dialog");if(!t)return;const n=t.querySelector(".turn-completion-message"),o=t.querySelector("#switch-players-btn");n&&(e==="online_end"?(n.querySelector("h3").textContent="Your turn has been completed",n.querySelector("p").textContent="Waiting for your opponent..."):e==="online_start"?(n.querySelector("h3").textContent="It's your turn",n.querySelector("p").textContent="Your opponent did the following:"):(n.querySelector("h3").textContent="Your turn has been completed",n.querySelector("p").textContent="Click below to switch players")),o&&(e==="online_end"?o.textContent="End Turn":e==="online_start"?o.textContent="Start Turn":o.textContent="Switch Players"),e==="online_start"?bo():dt();const s=document.querySelector(".game-container");s&&s.classList.add("dialog-blocking"),t.style.display="flex"},so=()=>{(c.currentPlayer===1?"player1":"player2")!==p.localPlayerId&&($.activePlayerId=p.localPlayerId,$.opponentPlayerId=p.localPlayerId==="player1"?"player2":"player1",I()),E()},ro=()=>{const e=Qe||(p.enabled?"online_end":"local_end");e==="online_end"?(pt(),mn(),kt(),Ae(),so()):e==="online_start"?(mo(),Ae(),dt(),E()):(pt(),kt(),co(),Ae())},Ae=()=>{const e=document.getElementById("turn-completion-dialog");e&&(e.style.display="none"),Qe=null;const t=document.querySelector(".game-container");t&&t.classList.remove("dialog-blocking")},lo=()=>{const e=document.getElementById("token-discard-modal");e&&(e.style.display="none");const t=document.getElementById("royal-cards-trigger");t&&(t.style.display="none");const n=document.querySelector(".pyramid-row:first-child");if(n&&!document.getElementById("discard-pending-container")){const s=document.createElement("div");s.id="discard-pending-container",s.className="discard-pending-container",s.innerHTML=`
      <div class="discard-pending-message">
        <span>Select tokens to discard</span>
      </div>
      <div id="restore-discard-btn" class="royal-cards-summary card-shaped restore-discard-button">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 4px; padding: 8px;">
          <div style="font-size: 1.8em;">üìã</div>
          <div style="font-size: 0.65em; text-align: center; line-height: 1.2;">Discard ${ge}</div>
        </div>
      </div>
    `,n.appendChild(s);const l=document.getElementById("restore-discard-btn");l&&(l.onclick=Yt)}const o=document.querySelector(".game-container");o&&(o.classList.remove("dialog-blocking"),o.classList.add("discard-pending"))},Yt=()=>{const e=document.getElementById("discard-pending-container");e&&e.remove();const t=document.getElementById("royal-cards-trigger");t&&(t.style.display="");const n=document.getElementById("token-discard-modal");n&&(n.style.display="flex");const o=document.querySelector(".game-container");o&&(o.classList.remove("discard-pending"),o.classList.add("dialog-blocking"))};let Xe=null;const he=(e,t,n=null)=>{const o=document.getElementById("confirmation-modal"),s=document.getElementById("confirmation-message"),l=document.getElementById("confirmation-confirm-btn"),a=document.getElementById("confirmation-cancel-btn");if(!o||!s||!l||!a)return;s.innerHTML=`<p>${e}</p>`,Xe=t,l.onclick=()=>{const i=Xe;wt(),i&&i()},a.onclick=()=>{const i=n;wt(),i&&i()};const r=document.querySelector(".game-container");r&&r.classList.add("dialog-blocking"),o.style.display="flex"},wt=()=>{const e=document.getElementById("confirmation-modal");e&&(e.style.display="none");const t=document.querySelector(".game-container");t&&t.classList.remove("dialog-blocking"),Xe=null},Ft=()=>{const e=c.currentPlayer===1?"player1":"player2",t=c.players[e],o=We(e)-10;F=[],Ze=!0,ge=o;const s=document.querySelector(".game-container");s&&s.classList.add("dialog-blocking");const l=document.getElementById("token-discard-modal"),a=document.getElementById("token-discard-message"),r=document.getElementById("token-discard-grid");if(document.getElementById("confirm-discard-btn"),!l||!a||!r)return;a.innerHTML=`
    <p>You may not keep more than 10 tokens. Select ${o} token${o>1?"s":""} to discard.</p>
  `;const i=["blue","white","green","red","black","pearl","gold"],d=i.reduce((v,b)=>v+(t.tokens[b]||0),0);let u=4;d>15?u=6:d>12&&(u=5);const y=u>=6?26:u===5?30:34;r.style.gridTemplateColumns=`repeat(${u}, minmax(0, 1fr))`;let f="";i.forEach(v=>{const b=t.tokens[v]||0;for(let w=0;w<b;w++){const T=`${v}-${w}`;let C;v==="pearl"?C=le(y):v==="gold"?C=Ce(y):C=ae(v,y),f+=`
        <div class="token-discard-item" data-token-id="${T}" data-token-color="${v}" onclick="toggleTokenDiscard('${T}', '${v}')">
          ${C}
        </div>
      `}}),r.innerHTML=f,Jt(),l.style.display="flex"},ao=(e,t)=>{if(!R("Only the active player can discard tokens.")||!Ze)return;const n=F.findIndex(s=>s.id===e),o=document.querySelector(`[data-token-id="${e}"]`);n>=0?(F.splice(n,1),o&&o.classList.remove("selected")):F.length<ge&&(F.push({id:e,color:t}),o&&o.classList.add("selected")),Jt()},Jt=()=>{const e=document.getElementById("confirm-discard-btn");if(e){const t=F.length===ge;e.disabled=!t,e.style.opacity=t?"1":"0.5",e.style.cursor=t?"pointer":"not-allowed"}},io=()=>{if(!R("Only the active player can discard tokens.")||F.length!==ge)return;const e=c.currentPlayer===1?"player1":"player2",t=c.players[e];F.forEach(({color:a})=>{t.tokens[a]>0&&(t.tokens[a]--,c.bag[a]=(c.bag[a]||0)+1)}),X("tokens_discarded",{tokens:It(F.map(a=>a.color))}),F=[],Ze=!1,ge=0;const n=document.getElementById("discard-pending-container");n&&n.remove();const o=document.getElementById("royal-cards-trigger");o&&(o.style.display="");const s=document.getElementById("token-discard-modal");s&&(s.style.display="none");const l=document.querySelector(".game-container");l&&(l.classList.remove("dialog-blocking"),l.classList.remove("discard-pending")),I(),W?W=!1:Q()};window.confirmTokenDiscard=io;window.toggleTokenDiscard=ao;window.minimizeDiscardModal=lo;window.maximizeDiscardModal=Yt;const co=()=>{const e=$.activePlayerId;$.activePlayerId=$.opponentPlayerId,$.opponentPlayerId=e,c.currentPlayer=$.activePlayerId==="player1"?1:2;const t=document.getElementById("player-hand"),n=document.getElementById("opponent-stats");t&&t.classList.add("switching"),n&&n.classList.add("switching"),setTimeout(()=>{n&&(n.innerHTML=qt()),t&&(t.innerHTML=jt($.activePlayerId));const o=Ke(),s=document.querySelector(".card-pyramid");s&&[{key:"level1",level:1},{key:"level2",level:2},{key:"level3",level:3}].forEach(({key:a,level:r})=>{const i=c.pyramid[a];Array.from(s.querySelectorAll(`.card-v2[data-card-level="${r}"]`)).forEach(u=>{const y=parseInt(u.getAttribute("data-card-index"),10);if(!isNaN(y)&&y<i.length){const f=i[y];pe(f,o).affordable?u.classList.add("affordable"):u.classList.remove("affordable")}})}),setTimeout(()=>{t&&t.classList.remove("switching"),n&&n.classList.remove("switching")},50)},300)},po=()=>{document.querySelectorAll("[data-popover-handler]").forEach(t=>t.removeEventListener("click",t._popoverHandler)),document.querySelectorAll('.card[data-clickable="card"]').forEach(t=>{t._popoverHandler=n=>{const o=t.dataset.cardLevel,s=parseInt(t.dataset.cardIndex,10),l=`level${o}`,a=c.pyramid[l][s];G("card-detail-popover",a,t)},t.addEventListener("click",t._popoverHandler)}),document.querySelectorAll('[data-clickable="popover"]').forEach(t=>{t._popoverHandler=n=>{const o=t.dataset.popover;o==="token-selection-modal"?(x=[],K=!1,_=null,xe=!1,G(o),setTimeout(()=>{Te(),Se(),V()},100)):G(o)},t.addEventListener("click",t._popoverHandler)}),document.querySelectorAll('[data-clickable="reserve-deck"]').forEach(t=>{t._deckReserveHandler=n=>{const o=parseInt(t.dataset.deckLevel,10);o>=1&&o<=3&&Gt(o)},t.addEventListener("click",t._deckReserveHandler)}),document.querySelectorAll('[data-clickable="reserve-target"]').forEach(t=>{t._reserveTargetHandler=n=>{const o=t.dataset.cardLevel,s=parseInt(t.dataset.cardIndex,10),l=`level${o}`,a=c.pyramid[l][s];Ht(a)},t.addEventListener("click",t._reserveTargetHandler)})},I=()=>{document.querySelector("#app").innerHTML=Ln(),setTimeout(()=>{po(),Bn();const e=document.getElementById("switch-players-btn");e&&(e._handlerAttached&&e.removeEventListener("click",e._clickHandler),e._clickHandler=ro,e.addEventListener("click",e._clickHandler),e._handlerAttached=!0),E()},10)};let Be=0;const uo=5,Vt=()=>{!p.enabled||!p.sessionId||(Be=0,ye.startPolling(2e3,(e,t)=>{if(t){if(console.error("Poll error:",t),t.type==="not_found"||t.status===404){console.warn("Session not found, stopping polling"),yo(),p.enabled=!1,p.syncStatus="offline",E();return}Be++,Be>=uo&&(p.syncStatus="degraded",E());return}if(Be=0,e&&e.version>p.version){const n=p.localPlayerId,o=ke();et(e.state_blob),$.activePlayerId=n,$.opponentPlayerId=n==="player1"?"player2":"player1";const s=ke();p.version=e.version,p.syncStatus="online",Ae(),I(),E(),!o&&s&&it("online_start")}else e&&(p.syncStatus="online",E())}),p.pollTimerId=ye.pollTimerId)},yo=()=>{ye.stopPolling(),p.pollTimerId=null},kt=async()=>{if(!(!p.enabled&&(c.currentPlayer===1?"player1":"player2")!==$.activePlayerId))try{console.log("Syncing turn - current player:",c.currentPlayer,"local player:",p.localPlayerId,"version:",p.version),await Lt("turn complete")&&(E(),console.log("Turn synced successfully, new version:",p.version))}catch(e){console.error("Failed to sync after turn:",e),e.type==="version_conflict"?e.current&&(et(e.current.state_blob),p.version=e.current.version,p.syncStatus="online",E(),console.warn("Version conflict resolved - remote state applied")):(p.syncStatus="degraded",E())}},E=()=>{const e=document.getElementById("sync-indicator"),t=document.getElementById("sync-mode"),n=document.getElementById("sync-session-id"),o=document.getElementById("sync-turn-indicator");if(!(!e||!t)){if(p.syncStatus==="online"?(e.style.backgroundColor="#4caf50",e.title="Online - Synced"):p.syncStatus==="degraded"?(e.style.backgroundColor="#ff9800",e.title="Degraded - Connection issues"):(e.style.backgroundColor="#9e9e9e",e.title="Offline - Local mode"),p.enabled){const s=p.localPlayerId?` (${p.localPlayerId==="player1"?"P1":"P2"})`:"";t.textContent=`Online${s}`,n&&p.sessionId&&(n.textContent=`Session: ${se(p.sessionId)}`,n.style.display="inline")}else t.textContent="Local",n&&(n.style.display="none");o&&(o.classList.remove("active","waiting"),!p.enabled||!p.localPlayerId?o.textContent="":ke()?(o.textContent="Your turn",o.classList.add("active")):(o.textContent="Waiting on opponent",o.classList.add("waiting"))),tt()}},Xt=()=>{if(!p.localPlayerId)return[];const e=Array.isArray(B.turns)?B.turns:[],t=[];for(let n=e.length-1;n>=0;n--){const o=e[n];if(o){if(o.playerId===p.localPlayerId)break;t.unshift(o)}}return t},ct=()=>{const e=Xt();return e.length?e[e.length-1].id:null},fo=()=>{const e=ct();return!!(e&&e!==p.lastSeenTurnId)},mo=()=>{const e=ct();e&&(p.lastSeenTurnId=e)},De=e=>!e||e==="none"?"Neutral":e.charAt(0).toUpperCase()+e.slice(1),_e=e=>{if(!e)return"card";const t=De(e.color),n=e.crowns?`, ${e.crowns} crowns`:"",o=e.ability?`, ability: ${e.ability}`:"";return`Lvl ${e.level} ${t} (${e.points||0} pts${n}${o})`},vo=(e,t=18)=>e?e==="gold"?Ce(t):e==="pearl"?le(t):e==="wild"?Ne(t):ae(e,t):"",be=(e=[])=>!e||!e.length?"":`<span class="token-icon-row">${e.map(t=>`
      <span class="token-icon-wrapper">
        ${vo(t.color,20)}
        ${t.count>1?`<span class="token-count">√ó${t.count}</span>`:""}
      </span>
    `).join("")}</span>`,go=e=>{const t=(n,o)=>`
    <div class="turn-event-row">
      <span class="turn-event-label">${n}</span>
      <span class="turn-event-content">${o}</span>
    </div>
  `;switch(e.type){case"tokens_taken":return t("Tokens",`${be(e.tokens)||"Collected tokens"}${e.scrollReasons?.length?'<span class="turn-event-note">Scroll awarded</span>':""}`);case"bonus_token_collected":return t("Bonus",`${e.bonusColor?`${De(e.bonusColor)} `:""}${be(e.tokens)}`);case"board_refilled":return t("Refill",`Filled ${e.tokensPlaced||0} slots and granted opponent a scroll.`);case"card_reserved":{const n=e.card?.costs?Ct(e.card.costs):[],o=n.length?`<span class="turn-event-costs">${be(n)}</span>`:"";return t("Reserved",`${_e(e.card)}${e.goldAwarded?'<span class="turn-event-note">+ gold</span>':""}${o}`)}case"card_purchased":{const n=e.tokensSpent&&e.tokensSpent.length?`<div>${be(e.tokensSpent)}</div>`:"";return t("Purchased",`${_e(e.card)}${e.fromReserve?" (from reserve)":""}${n}`)}case"scroll_token":return t("Scroll",`Took a ${De(e.token)} token`);case"token_stolen":return t("Steal",`Took a ${De(e.color)} token`);case"tokens_discarded":return t("Discarded",be(e.tokens)||"Returned tokens to the bag");case"royal_acquired":return t("Royal",`Claimed ${_e(e.card)}`);case"repeat_turn_awarded":return t("Repeat",`Extra turn granted by ${_e(e.card)}`);default:return t("Event",e.type.replace(/_/g," "))}},ho=e=>e.length?e.map(t=>{const n=(t.events||[]).map(go).join("")||'<div class="turn-event-row"><span class="turn-event-content">No logged actions.</span></div>',o=(t.events||[]).some(s=>s.type==="repeat_turn_awarded");return`
      <div class="turn-summary-entry">
        <div class="turn-summary-entry-header">
          <span>Opponent Turn ${t.turnNumber||""}</span>
          ${o?'<span class="turn-summary-badge">Repeat chain</span>':""}
        </div>
        <div class="turn-summary-events">
          ${n}
        </div>
      </div>
    `}).join(""):'<div class="turn-summary-entry"><div class="turn-event-row"><span class="turn-event-content">No recorded actions.</span></div></div>',bo=()=>{const e=document.getElementById("turn-summary-container"),t=document.getElementById("turn-summary-list");if(!e||!t)return;const n=Xt(),o=ct();if(!n.length||o&&o===p.lastSeenTurnId){e.style.display="none";return}t.innerHTML=ho(n),e.style.display="flex"},dt=()=>{const e=document.getElementById("turn-summary-container"),t=document.getElementById("turn-summary-list");e&&(e.style.display="none"),t&&(t.innerHTML="")},wo=()=>{!p.enabled||!p.localPlayerId||ke()&&fo()&&setTimeout(()=>it("online_start"),50)};window.showModeSelection=()=>{if(!p.serviceAvailable)return;const e=document.getElementById("mode-selection-modal");if(e){e.style.display="flex",e.style.pointerEvents="auto";const t=document.querySelector(".game-container");t&&t.classList.add("dialog-blocking")}};window.closeModeSelection=()=>{const e=document.getElementById("mode-selection-modal");if(e){e.style.display="none",e.style.pointerEvents="none";const t=document.querySelector(".game-container");t&&t.classList.remove("dialog-blocking")}};window.selectLocalMode=()=>{p.enabled=!1,p.localPlayerId=null,E(),window.closeModeSelection()};window.hostOnlineGame=async()=>{try{ce.length===0&&(Tt(),I()),ze(),c.syncAssignments.player1Id=Z,c.syncAssignments.player2Id=null;const e=Et(),t={player1_assigned:!0,player2_assigned:!1},n=await ye.createSession(e,t);p.enabled=!0,p.sessionId=n.session_id,p.version=n.version,p.localPlayerId="player1",p.isHost=!0,p.syncStatus="online",$.activePlayerId="player1",$.opponentPlayerId="player2",c.currentPlayer=1;const o=new URL(window.location);o.searchParams.set("session",se(n.session_id)),o.searchParams.set("role","p1"),window.history.replaceState({},"",o),Vt(),E();const s=document.getElementById("session-info-modal"),l=document.getElementById("session-id-display"),a=document.getElementById("session-link-display");if(s&&l&&a){const r=se(n.session_id),i=ot(n.session_id);l.textContent=r,a.textContent=i;const d=document.getElementById("session-qr-image");d&&i&&(d.src=st(i),d.style.display=""),s.style.display="flex",s.style.pointerEvents="auto";const u=document.querySelector(".game-container");u&&u.classList.add("dialog-blocking")}window.closeModeSelection()}catch(e){console.error("Failed to host game:",e),alert("Failed to create online session. Please try again.")}};window.showJoinDialog=()=>{window.closeModeSelection();const e=document.getElementById("join-game-modal");if(e){e.style.display="flex",e.style.pointerEvents="auto";const t=document.querySelector(".game-container");t&&t.classList.add("dialog-blocking");const n=document.getElementById("join-session-input");n&&(n.value="",setTimeout(()=>n.focus(),100))}};window.closeJoinDialog=()=>{const e=document.getElementById("join-game-modal");if(e){e.style.display="none",e.style.pointerEvents="none";const t=document.querySelector(".game-container");t&&t.classList.remove("dialog-blocking")}};window.confirmJoinGame=async()=>{const e=document.getElementById("join-session-input");if(!e||!e.value.trim()){alert("Please enter a session ID");return}const t=e.value.trim(),n=nt(t);if(!n){alert("Please enter a valid session ID");return}if(await Kt(n,"p2")){window.closeJoinDialog();const s=new URL(window.location);s.searchParams.set("session",n),s.searchParams.delete("role"),window.history.replaceState({},"",s)}else alert("Failed to join session. Please check the session ID and try again.")};window.showSettings=()=>{const e=document.getElementById("settings-modal"),t=document.getElementById("settings-content");if(!e||!t)return;const n=se(p.sessionId),o=ot(p.sessionId),s=st(o);let l="";p.enabled&&p.sessionId?l+=`
      <div style="margin-bottom: 15px;">
        <p><strong>Session ID:</strong></p>
        <div class="session-id-display">${n}</div>
        <button class="action-button" onclick="window.copySessionId()" style="margin-top: 5px; font-size: 12px;">Copy Session ID</button>
      </div>
      <div style="margin-bottom: 15px;">
        <p><strong>Share Link:</strong></p>
        <div class="session-link-display" id="share-link-display">${o}</div>
        <button class="action-button" onclick="window.copyShareLink()" style="margin-top: 5px; font-size: 12px;">Copy Link</button>
        <div class="qr-wrapper">
          <img id="settings-qr-image" src="${s||""}" alt="Share QR code" style="${s?"":"display:none;"}" />
        </div>
      </div>
    `:(l+="<p>You are playing in local mode.</p>",p.serviceAvailable?l+='<button class="action-button" onclick="window.closeSettings(); window.showModeSelection();" style="margin-top: 10px;">Switch to Online Mode</button>':l+='<p style="font-size: 12px; color: #666;">Online sync is not available.</p>'),t.innerHTML=l,e.style.display="flex",e.style.pointerEvents="auto";const a=document.querySelector(".game-container");if(a&&a.classList.add("dialog-blocking"),p.enabled&&p.sessionId){const r=document.getElementById("share-link-display");r&&(r.textContent=o);const i=document.getElementById("settings-qr-image");i&&s?(i.src=s,i.style.display=""):i&&!s&&(i.style.display="none")}};window.closeSettings=()=>{const e=document.getElementById("settings-modal");if(e){e.style.display="none",e.style.pointerEvents="none";const t=document.querySelector(".game-container");t&&t.classList.remove("dialog-blocking")}};window.copySessionId=()=>{if(p.sessionId){const e=se(p.sessionId);navigator.clipboard.writeText(e||p.sessionId).then(()=>{alert("Session ID copied to clipboard!")}).catch(()=>{alert("Failed to copy. Session ID: "+(e||p.sessionId))})}};window.copyShareLink=()=>{const e=document.getElementById("share-link-display");e&&e.textContent&&navigator.clipboard.writeText(e.textContent).then(()=>{alert("Link copied to clipboard!")}).catch(()=>{alert("Failed to copy link.")})};window.copySessionInfo=()=>{const e=document.getElementById("session-link-display");e&&e.textContent&&navigator.clipboard.writeText(e.textContent).then(()=>{alert("Link copied to clipboard!")}).catch(()=>{alert("Failed to copy link.")})};window.closeSessionInfo=()=>{const e=document.getElementById("session-info-modal");if(e){e.style.display="none",e.style.pointerEvents="none";const t=document.querySelector(".game-container");t&&t.classList.remove("dialog-blocking")}};window.updateSyncIndicator=E;const Kt=async(e,t=null)=>{try{const n=await ye.loadSession(e),o=n.meta||{};if(o.player2_assigned&&t!=="p1")throw{type:"player_conflict",message:"Player 2 is already assigned. Someone else is already playing as player 2."};let s=t==="p1"?"player1":"player2";const l=t==="p1";if(console.log("Joining session as:",s,"Session meta:",o,"Reconnecting host:",l),!et(n.state_blob))throw new Error("Failed to apply synced state");const a=c.currentPlayer;ze();const r=c.syncAssignments;let i=!1;if(s==="player1"){if(r.player1Id&&r.player1Id!==Z)throw{type:"player_conflict",message:"Player 1 is already assigned on another device."};r.player1Id!==Z&&(r.player1Id=Z,i=!0)}else{if(r.player2Id&&r.player2Id!==Z)throw{type:"player_conflict",message:"Player 2 is already assigned on another device."};r.player2Id!==Z&&(r.player2Id=Z,i=!0)}p.enabled=!0,p.sessionId=n.session_id,p.version=n.version,p.localPlayerId=s,p.isHost=l,p.syncStatus="online";const d=new URL(window.location);if((!d.searchParams.has("session")||d.searchParams.get("session")!==n.session_id)&&(d.searchParams.set("session",n.session_id),l?d.searchParams.set("role","p1"):d.searchParams.delete("role"),window.history.replaceState({},"",d)),$.activePlayerId=s,$.opponentPlayerId=s==="player1"?"player2":"player1",i)try{c.currentPlayer=a,await Lt("player assignment")}catch(u){console.warn("Failed to push assignment update:",u)}return Vt(),E(),I(),console.log("Joined session as:",s,"View shows:",$.activePlayerId,"Current player in game:",c.currentPlayer),wo(),!0}catch(n){return console.error("Failed to join session:",n),n.type==="not_found"?(console.warn("Session not found:",e),alert("Session not found. Please check the session ID.")):n.type==="load_failed"?(console.warn("Failed to load session:",n.message),alert("Failed to load session. Please try again.")):n.type==="player_conflict"&&alert(n.message),p.enabled=!1,p.syncStatus="offline",E(),!1}},ko=async()=>{const e=new URLSearchParams(window.location.search),t=e.get("session"),n=nt(t),o=e.get("role"),s=await ye.checkStatus();if(p.serviceAvailable=s,p.syncStatus=s?"online":"offline",n&&s){const r=o==="p1"?"p1":null;if(await Kt(n,r)){console.log("Joined/reconnected to session:",n,"as",p.localPlayerId);const d=se(n),u=new URL(window.location);d?u.searchParams.set("session",d):u.searchParams.set("session",n),r==="p1"?u.searchParams.set("role","p1"):u.searchParams.delete("role"),window.history.replaceState({},"",u),E(),console.log("Game state initialized from session:",{totalCards:ce.length,pyramid:c.pyramid,bag:c.bag,boardTokens:c.board.flat().filter(y=>y!==null).length,royalCards:c.royalCards.length,currentPlayer:c.currentPlayer,localPlayer:p.localPlayerId,isHost:p.isHost}),I();return}else{console.warn("Failed to join session, initializing local game");const d=new URL(window.location);d.searchParams.delete("session"),d.searchParams.delete("role"),window.history.replaceState({},"",d)}}Tt(),E(),s&&!n&&setTimeout(()=>{typeof window.showModeSelection=="function"&&window.showModeSelection()},500),console.log("Game state initialized:",{totalCards:ce.length,pyramid:c.pyramid,bag:c.bag,boardTokens:c.board.flat().filter(r=>r!==null).length,royalCards:c.royalCards.length,currentPlayer:c.currentPlayer});const l=ce.filter(r=>r.costs.pearl>0);console.log("Cards with pearl costs:",l.length);const a=c.pyramid.level1.filter(r=>r.costs.pearl>0).length+c.pyramid.level2.filter(r=>r.costs.pearl>0).length+c.pyramid.level3.filter(r=>r.costs.pearl>0).length;console.log("Pyramid cards with pearls:",a),I()};ko();</script>
    <style rel="stylesheet" crossorigin>:root{--board-color: #8b7355;--token-blue: #4a90e2;--token-white: #f0f0f0;--token-green: #7ed321;--token-black: #2c3e50;--token-red: #e74c3c;--token-gold: #f39c12;--token-pearl: #d5c9b8;--card-back: #c9a961;--player-area-bg: #f5f5f5;--opponent-area-bg: #e5e5e5;--mini-panel-scale: .38;--mini-panel-offset: 100px}*{box-sizing:border-box;margin:0;padding:0}body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:0;margin:0;overflow-x:hidden;display:flex;justify-content:center;align-items:center}#app{width:390px;height:1325px;margin:0 auto;background:#fff;box-shadow:0 10px 40px #0000004d;border-radius:20px;overflow:hidden;display:flex;flex-direction:column;position:relative}@media(max-width:600px){#app{width:100vw;height:100vh;border-radius:0}}.game-container{display:flex;flex-direction:column;height:100%;min-height:0}.sync-controls-bar{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;background:#f8f8f8;border-bottom:1px solid #e0e0e0;font-size:11px;flex-shrink:0}.sync-status{display:flex;align-items:center;gap:6px}.sync-indicator{width:8px;height:8px;border-radius:50%;background-color:#9e9e9e;display:inline-block}.sync-mode{font-weight:500;color:#666}.sync-session-id{font-family:monospace;font-size:10px;color:#888;margin-left:8px}.session-id-display,.session-link-display{background:#f0f0f0;padding:10px;border-radius:4px;margin:10px 0;font-size:12px;word-break:break-all;font-family:monospace}.qr-wrapper{display:flex;justify-content:center;margin-top:10px}.qr-wrapper img{width:170px;height:170px;border:1px solid #e0e0e0;border-radius:8px;background:#fff;padding:6px}.sync-turn-indicator{font-size:10px;text-transform:uppercase;letter-spacing:.04em;color:#999}.sync-turn-indicator.active{color:#4caf50}.sync-turn-indicator.waiting{color:#ff9800}.sync-turn-warning{display:none;padding:4px 12px;font-size:11px;text-align:center;background:#fff3e0;color:#bf360c;border-bottom:1px solid #ffe0b2}.sync-turn-warning.visible{display:block}.turn-summary-container{display:none;flex-direction:column;gap:6px;margin:10px 4px;background:#ffffff26;border-radius:12px;padding:10px 12px;border:1px solid rgba(255,255,255,.18);flex-shrink:1;min-height:0;overflow:hidden}.turn-summary-list{display:flex;flex-direction:column;gap:10px;max-height:200px;overflow-y:auto;overflow-x:hidden;padding-right:4px;flex-shrink:1;min-height:0}.turn-summary-entry{padding:8px 0;border-bottom:1px solid rgba(255,255,255,.18)}.turn-summary-entry:last-child{border-bottom:none}.turn-summary-entry-header{display:flex;justify-content:space-between;align-items:center;font-size:12px;font-weight:600;color:#f2f2f2}.turn-summary-badge{font-size:10px;color:#ffe3b0;border:1px solid rgba(255,227,176,.6);background:#ffe3b026;border-radius:999px;padding:1px 6px}.turn-summary-events{display:flex;flex-direction:column;gap:6px;margin-top:8px}.turn-event-row{display:flex;gap:8px;align-items:flex-start;font-size:12px;color:#f0f0f0}.turn-event-label{min-width:85px;font-weight:600;color:#fffc}.turn-event-content{flex:1;color:#fffffff2}.turn-event-note{display:inline-flex;margin-left:6px;font-size:11px;color:#ffe3b0;background:#ffe3b026;border-radius:999px;padding:1px 6px}.token-icon-row{display:inline-flex;flex-wrap:wrap;gap:6px;align-items:center}.token-icon-wrapper{display:inline-flex;align-items:center;gap:4px;background:transparent;border-radius:20px;padding:0;box-shadow:none}.token-count{font-size:11px;color:#ffffffd9}.settings-btn{background:none;border:none;font-size:16px;cursor:pointer;padding:4px 8px;color:#666;border-radius:4px;transition:background-color .2s}.settings-btn:hover{background-color:#e0e0e0}.mode-selection-buttons{display:flex;flex-direction:column;gap:12px;margin:20px 0;width:100%}.mode-selection-buttons .action-button{width:100%;padding:14px 24px;font-size:15px}.top-bar{display:flex;justify-content:flex-start;align-items:flex-start;padding:8px;gap:8px;flex-shrink:0;min-height:140px;box-sizing:border-box}.token-board-container{flex:0 0 30%;max-width:30%;display:flex;align-items:flex-start;justify-content:flex-start;overflow:hidden;min-height:117px}.token-board-container .token-board{width:100%;max-width:100%;padding:2px}.token-board-container .token-spaces{gap:.5px;padding:0}.opponent-stats-container{flex:1 1 auto;max-width:none;min-width:0;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;gap:6px;overflow:hidden}.opponent-resources-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;gap:8px}.opponent-victory-tracker-left{display:flex;gap:3px;align-items:center;flex:0 0 auto;min-width:0;margin-right:auto}.opponent-resources{display:flex;gap:4px;align-items:center;flex-shrink:0}.opponent-hand-header-left{display:flex;gap:2px;margin-right:4px}.opponent-hand-header-right{display:flex;gap:4px;align-items:center}.opponent-hand-header-right .stat-icon{width:22px;height:22px;border-width:1.5px}.opponent-hand-header-right .stat-count{font-size:.6em}.opponent-player-scrolls{display:flex;gap:2px}.opponent-player-scrolls .privilege-scroll-emoji{font-size:1em}.opponent-color-cards-row{display:flex;gap:3px;align-items:center;width:100%;margin-top:6px}.opponent-color-card{flex:1;min-width:38px;height:62px;border:1.5px solid #333;border-radius:3px;background:#fff;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:15px 3px 3px}.opponent-color-card.blue{border-color:var(--token-blue);background:#4a90e21a}.opponent-color-card.white{border-color:#ccc;background:#f0f0f04d}.opponent-color-card.green{border-color:var(--token-green);background:#7ed3211a}.opponent-color-card.red{border-color:var(--token-red);background:#e74c3c1a}.opponent-color-card.black{border-color:var(--token-black);background:#2c3e501a}.opponent-color-card-empty{background:transparent!important;border:1.5px dashed #ccc!important}.opponent-color-card .card-stripe-top,.opponent-color-card .card-stripe-bottom{width:100%;position:absolute;left:0;border-radius:3px}.opponent-color-card .card-stripe-top{top:0;height:100%;clip-path:polygon(0 0,100% 0,100% 50%,0 25%);z-index:1}.opponent-color-card .card-stripe-top:after{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.4) 0%,transparent 50%,rgba(0,0,0,.1) 100%);border-radius:3px;pointer-events:none}.opponent-color-card .card-stripe-bottom{bottom:0;height:18px;z-index:1;display:flex;align-items:center;justify-content:center}.opponent-wild-token-icon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1;opacity:.6}.opponent-color-card .opponent-power-circle{position:absolute;top:-3px;right:-8px;width:21px;height:21px;border-radius:3.25px;display:flex;align-items:center;justify-content:center;font-size:.55em;font-weight:700;color:#fff;text-shadow:0 0 1px rgba(0,0,0,.5);z-index:20;box-shadow:0 2px 4px #0000004d}.opponent-power-circle.blue{background:var(--token-blue)}.opponent-power-circle.white{background:var(--token-white);border:.5px solid #ccc;color:#333;text-shadow:none}.opponent-power-circle.green{background:var(--token-green)}.opponent-power-circle.red{background:var(--token-red)}.opponent-power-circle.black{background:var(--token-black)}.opponent-points-value{position:absolute;bottom:0;left:0;right:0;height:18px;display:flex;align-items:center;justify-content:center;font-size:.6em;font-weight:700;z-index:2}.opponent-points-value:not(.white){color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.5)}.opponent-points-value.white{color:#333;text-shadow:-1px -1px 0 white,1px -1px 0 white,-1px 1px 0 white,1px 1px 0 white,0 -1px 0 white,0 1px 0 white,-1px 0 0 white,1px 0 0 white}.opponent-reserved-section{flex:1;min-width:38px;height:62px;border-radius:3px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:default;pointer-events:none;padding:3px}.opponent-reserved-section-empty{border:1.5px dashed #999;background:transparent}.opponent-reserved-section-filled{border:1.5px solid #333;background:#e0e0e0}.opponent-reserved-count{font-size:1em;font-weight:700;color:#333;margin-bottom:2px;text-align:center}.opponent-reserved-label{font-size:.4em;color:#666;text-align:center}.opponent-buying-power{display:flex;gap:6px;justify-content:space-between;align-items:center;flex-wrap:nowrap;max-width:100%;padding:0;width:100%}.power-circle{width:31px;height:23px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.65em;font-weight:700;color:#fff;text-shadow:0 0 2px rgba(0,0,0,.5);flex-shrink:0}.power-circle.blue{background:var(--token-blue)}.power-circle.white{background:var(--token-white);border:1px solid #ccc;color:#333;text-shadow:none}.power-circle.green{background:var(--token-green)}.power-circle.red{background:var(--token-red)}.power-circle.black{background:var(--token-black)}.power-number{line-height:1}.pyramid-container{flex:1;position:relative;min-height:0;overflow:visible;padding:0 8px 8px}.player-stats-bar{display:flex;justify-content:space-between;align-items:center;padding:8px;background:#f9f9f9;border-top:1px solid #e0e0e0;flex-shrink:0;gap:0}.player-stats-left{display:flex;align-items:center;gap:8px}.player-resources{display:flex;gap:8px;align-items:center;justify-content:flex-end}.main-display-container{position:relative;flex:1;min-height:400px;display:flex;align-items:stretch;justify-content:center;overflow:visible}.board-panel{position:absolute;inset:0 8px;display:flex;align-items:flex-start;justify-content:center;transition:transform .4s ease,opacity .3s ease;transform-origin:top center;cursor:pointer;pointer-events:auto;padding-top:8px}.board-panel>.card-pyramid,.board-panel>.token-board{width:100%}.board-panel-primary{z-index:2;transform:translateY(0) scale(1);opacity:1}.board-panel-secondary,.board-swapped .board-panel-primary{z-index:10;transform:translateY(calc(100% - var(--mini-panel-offset))) scale(var(--mini-panel-scale));opacity:.9}.board-swapped .board-panel-secondary{z-index:2;transform:translateY(0) scale(1);opacity:1}.fades-when-mini{transition:opacity .2s ease}.board-swapped .fades-when-mini,.board-panel-secondary .fades-when-mini{opacity:0}.board-panel-primary .fades-when-mini,.board-swapped .board-panel-secondary .fades-when-mini{opacity:1}.card-pyramid{padding:0;width:100%;position:relative;display:flex;flex-direction:column;transition:background-color .3s ease}.card-pyramid.reserve-mode{background-color:gray;border-radius:0;padding:4px 6px;margin-left:-6px;margin-right:-6px;width:calc(100% + 12px);position:relative;z-index:1}.reserve-royal-group{display:flex;align-items:flex-start;gap:8px;margin-left:4px}.reserve-royal-group .royal-cards-summary{flex-shrink:0}.reserve-mode-panel{display:flex;flex-direction:column;align-items:center;padding:0 8px;flex:1;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6);text-align:center}.reserve-mode-title{font-size:12px;font-weight:600;letter-spacing:.5px;text-transform:uppercase}.reserve-mode-cancel{font-size:10px;padding:4px 8px;margin-top:6px}.reserve-royal-group.reserve-mode-active{margin-left:4px;margin-right:4px}.reserve-toggle-button[disabled],.reserve-toggle-button[disabled]:hover{opacity:.4;cursor:not-allowed}.player-stats-bar .reserve-toggle-button{font-size:.75em;padding:4px 8px;min-height:0;height:auto;margin-left:8px;margin-right:0;flex-shrink:0}.deck-placeholder{width:36px;height:98px;background:#ffffff1a;border:1px dashed rgba(255,255,255,.5);border-radius:5px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:32px;cursor:pointer;transition:all .2s ease;text-shadow:0 2px 4px rgba(0,0,0,.4);flex-shrink:0}.deck-meter-container[data-clickable=reserve-deck]:hover .deck-placeholder{background:#fff3;border-style:solid;border-color:#fff;color:#fff;transform:scale(1.05)}.card-pyramid.reserve-mode .card{cursor:pointer;box-shadow:0 0 5px #ffffff80}.card-pyramid.reserve-mode .card:hover{transform:scale(1.05);box-shadow:0 0 8px #fffc;z-index:10}.reserve-confirm-modal{display:flex;flex-direction:column;align-items:center;gap:16px;padding:24px;height:100%;box-sizing:border-box}.reserve-confirm-modal h3{color:#fff}.reserve-confirm-card-wrapper{display:flex;justify-content:center;align-items:center;flex:1 1 auto}.reserve-confirm-card-container{transform:scale(1.5);transform-origin:center;filter:drop-shadow(0 4px 12px rgba(0,0,0,.35))}.reserve-confirm-actions{display:flex;gap:10px;margin-top:auto}.face-down-card{width:62px;height:98px;border-radius:6px;border:2px solid #333;background:linear-gradient(135deg,#6a6a6a,#9f9f9f);display:flex;align-items:center;justify-content:center;font-size:42px;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.4)}.pyramid-row{display:flex;justify-content:flex-start;align-items:flex-start;gap:4px;margin-bottom:4px;width:100%;padding:0 4px}.card-pyramid.reserve-mode .pyramid-row{gap:2px;padding:0}.card-pyramid.reserve-mode .deck-meter-container{margin-right:2px;margin-left:0}.card-spacer{flex-grow:1;flex-shrink:1;min-width:0}.pyramid-row:last-child{margin-bottom:0}.deck-meter-container{flex-shrink:0;margin-right:4px;cursor:pointer;transition:opacity .2s ease}.deck-meter-container:hover{opacity:.7}.deck-meter-container[data-clickable=deck-reserve]{position:relative}.deck-meter-container[data-clickable=deck-reserve]:after{content:"üì•";position:absolute;top:-8px;right:-8px;font-size:12px;opacity:0;transition:opacity .2s ease;pointer-events:none}.deck-meter-container[data-clickable=deck-reserve]:hover:after{opacity:1}.deck-meter{width:12px;height:98px;background:#2c3e5026;border:1px solid #888;border-radius:6px;position:relative;overflow:hidden}.meter-fill{position:absolute;bottom:0;left:0;right:0;border-radius:5px;transition:height .3s ease}.meter-fill,.meter-fill.level-3,.meter-fill.level-2,.meter-fill.level-1{background:#888}@media(min-width:900px){.deck-meter{height:102px}}.card{width:62px;height:98px;border-radius:5px;border:1px solid #333;background:var(--card-back);position:relative;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 1px 3px #0003;flex-shrink:0;flex-grow:0;min-width:62px;max-width:62px}.card-v2{container-type:size;position:relative;cursor:pointer;transition:transform .2s,box-shadow .2s;flex-shrink:0;flex-grow:0;background:#fff;width:62px;height:98px;border-radius:5px;border:1px solid #333;box-shadow:0 1px 3px #0003;min-width:62px;max-width:62px}.card-v2.large{width:186px;height:294px;border-radius:15px;border:3px solid #333;box-shadow:0 3px 9px #0003;min-width:186px;max-width:186px}.card-v2.large .card-stripe-top,.card-v2.large .card-stripe-top:after,.card-v2.large .card-stripe-bottom{border-radius:15px}.card-v2 .color-circle{width:32.26cqmin;height:32.26cqmin;border-radius:50%;position:absolute;top:3.23cqmin;left:8.06cqmin;display:flex;align-items:center;justify-content:center;border:3.23cqmin solid white;box-shadow:3.23cqmin 3.23cqmin 6.45cqmin #00000080}.card-v2 .color-circle .prestige-points{font-size:24cqmin!important;color:#fff;text-shadow:1.61cqmin 1.61cqmin 3.23cqmin rgba(0,0,0,.5);line-height:1!important;font-weight:700}.card-v2 .prestige-points:not(.wild-points):not(.white-points){position:absolute;top:4.84cqmin!important;left:6.45cqmin!important;font-size:24cqmin!important;font-weight:700;color:#fff;text-shadow:1.61cqmin 1.61cqmin 3.23cqmin rgba(0,0,0,.5);line-height:1!important}.card-v2 .prestige-points.white-points{position:absolute;top:4.84cqmin!important;left:8.06cqmin!important;font-size:24cqmin!important;font-weight:700;color:#333!important;line-height:1!important;text-shadow:-1.61cqmin -1.61cqmin 0 white,1.61cqmin -1.61cqmin 0 white,-1.61cqmin 1.61cqmin 0 white,1.61cqmin 1.61cqmin 0 white,0 -1.61cqmin 0 white,0 1.61cqmin 0 white,-1.61cqmin 0 0 white,1.61cqmin 0 0 white!important;z-index:10}.card-v2 .prestige-points.white-points:after{content:""}.card-v2 .prestige-points.wild-points{position:absolute;top:4.84cqmin!important;left:8.06cqmin!important;font-size:24cqmin!important;font-weight:700;color:#333;line-height:1!important;text-shadow:-1.61cqmin -1.61cqmin 0 white,1.61cqmin -1.61cqmin 0 white,-1.61cqmin 1.61cqmin 0 white,1.61cqmin 1.61cqmin 0 white,0 -1.61cqmin 0 white,0 1.61cqmin 0 white,-1.61cqmin 0 0 white,1.61cqmin 0 0 white;z-index:10}.card-v2 .card-stripe-top,.card-v2 .card-stripe-bottom{width:100%;position:absolute;left:0}.card-v2 .card-stripe-top{top:0;height:100%;border-radius:5px;clip-path:polygon(0 0,100% 0,100% 50%,0 25%)}.card-v2 .card-stripe-top:after{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.4) 0%,transparent 50%,rgba(0,0,0,.1) 100%);border-radius:5px;pointer-events:none}.card-v2 .card-stripe-bottom{bottom:0;height:9.68cqmin;border-radius:5px}.card-v2 .card-header{position:absolute;top:4.84cqmin;left:4.84cqmin;right:4.84cqmin;display:flex}.card-v2 .points-corner{position:absolute;top:0;left:0;width:80.65cqmin;height:80.65cqmin;background:#f39c12;clip-path:polygon(0 0,0 100%,100% 0)}.card-v2 .points-corner+.prestige-points{position:absolute;top:4.84cqmin!important;left:6.45cqmin!important;font-size:24cqmin!important;font-weight:700;color:#fff;text-shadow:1.61cqmin 1.61cqmin 3.23cqmin rgba(0,0,0,.5);line-height:1!important}.card-v2 .card-ability-container{position:absolute;top:6.45cqmin;right:6.45cqmin;display:flex;flex-direction:row;align-items:flex-start;gap:3.23cqmin;z-index:10}.card-v2 .card-ability,.card-v2 .card-crowns{display:flex;align-items:center;justify-content:center;font-size:25.81cqmin;line-height:1;filter:drop-shadow(.81cqmin .81cqmin 1.61cqmin rgba(0,0,0,.4))}.card-v2 .double-indicator{position:relative;width:41cqmin;height:29.03cqmin;display:flex;align-items:center;justify-content:center}.card-v2 .double-circle{position:absolute;width:29.03cqmin;height:29.03cqmin;border-radius:50%;border:1.61cqmin solid white;box-shadow:0 2cqmin 4cqmin #0006}.card-v2 .double-circle.white{border-color:#999}.card-v2 .double-circle-back{top:0;left:0;z-index:1}.card-v2 .double-circle-front{top:0;left:12cqmin;z-index:2}.card-v2 .card-crowns svg{width:27.42cqmin;height:27.42cqmin}.card-v2 .card-crowns.crown-single{width:27.42cqmin;height:27.42cqmin}.card-v2 .card-crowns.crown-stack{display:flex;flex-direction:column;gap:1.61cqmin}.card-v2 .card-crowns.crown-grid{display:grid;grid-template-columns:repeat(2,27.42cqmin);grid-template-rows:repeat(2,27.42cqmin);gap:1.61cqmin;width:auto;height:auto}.card-v2 .card-crowns.crown-grid>span{width:27.42cqmin;height:27.42cqmin}.card-v2 .card-costs{position:absolute;bottom:12.9cqmin;left:9.68cqmin;right:3.23cqmin;display:grid;grid-template-columns:repeat(2,1fr);gap:3.23cqmin;max-width:100%}.card-v2 .cost-item{width:29.03cqmin;height:29.03cqmin;border-radius:50%;border:1.61cqmin solid #333;display:flex;align-items:center;justify-content:center;position:relative}.card-v2 .cost-token{width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center}.card-v2 .cost-number{font-size:17cqmin;font-weight:700;color:#fff;text-shadow:1.61cqmin 1.61cqmin 1.61cqmin rgba(0,0,0,.5);line-height:1}.card-v2 .cost-item.white .cost-token .cost-number,.card-v2 .cost-item.white .cost-number{text-shadow:none}.card-v2 .cost-item.pearl{border:none!important;background:transparent!important;width:32.26cqmin;height:32.26cqmin;display:flex;align-items:center;justify-content:center;box-shadow:none!important}.card-v2 .cost-item.pearl .cost-token.pearl{width:32.26cqmin;height:32.26cqmin;background:transparent!important;border:none!important;display:flex;align-items:center;justify-content:center;box-shadow:none!important}.card-v2 .cost-item.pearl svg{width:32.26cqmin!important;height:32.26cqmin!important;display:block;filter:drop-shadow(1.61cqmin 1.61cqmin 3.23cqmin rgba(0,0,0,.3));background:transparent!important}.card-v2 .wild-icon-positioned{position:absolute;top:40.32cqmin;left:50%;transform:translate(-50%);z-index:10}.card-v2 .wild-icon-positioned svg{width:45.16cqmin;height:45.16cqmin}.card-v2.grey-card .card-stripe-top{height:38.71cqmin;background:#000}.card-v2.grey-card .card-stripe-bottom{height:4.84cqmin;background:#000}.card-v2.colored-card.blue .card-stripe-top{background-color:#4a90e2}.card-v2.colored-card.white .card-stripe-top{background-color:#f0f0f0}.card-v2.colored-card.green .card-stripe-top{background-color:#7ed321}.card-v2.colored-card.black .card-stripe-top{background-color:#2c3e50}.card-v2.colored-card.red .card-stripe-top{background-color:#e74c3c}.card-v2.colored-card.blue .card-stripe-bottom{background-color:#4a90e2}.card-v2.colored-card.white .card-stripe-bottom{background-color:#f0f0f0}.card-v2.colored-card.green .card-stripe-bottom{background-color:#7ed321}.card-v2.colored-card.black .card-stripe-bottom{background-color:#2c3e50}.card-v2.colored-card.red .card-stripe-bottom{background-color:#e74c3c}.card-v2 .cost-item.blue .cost-token{background:#4a90e2}.card-v2 .cost-item.white .cost-token{background:#f0f0f0}.card-v2 .cost-item.green .cost-token{background:#7ed321}.card-v2 .cost-item.red .cost-token{background:#e74c3c}.card-v2 .cost-item.black .cost-token{background:#2c3e50}.card-v2 .cost-item.white .cost-number{color:#333}@media(min-width:900px){.card{width:65px;height:102px;min-width:65px;max-width:65px}.card-spacer{height:102px}}.card:hover{transform:translateY(-5px);box-shadow:0 4px 12px #0000004d}.card-v2.affordable{border:3px solid #00D9FF;box-shadow:0 0 10px #00d9ffcc,0 0 20px #00d9ff99,0 0 30px #00d9ff66,0 1px 3px #0003;animation:affordablePulse 2s ease-in-out infinite}@keyframes affordablePulse{0%,to{box-shadow:0 0 10px #00d9ffcc,0 0 20px #00d9ff99,0 0 30px #00d9ff66,0 1px 3px #0003}50%{box-shadow:0 0 15px #00d9ff,0 0 30px #00d9ffcc,0 0 45px #00d9ff99,0 1px 3px #0003}}.card-v2.affordable:hover{transform:translateY(-5px);box-shadow:0 0 15px #00d9ff,0 0 30px #00d9ffcc,0 0 45px #00d9ff99,0 4px 12px #0000004d}.card,.colored-card,.wild-card{background:#fff}.grey-card{background:#2c2c2c}.card-stripe-top,.card-stripe-bottom{width:100%;position:absolute;left:0}.card-stripe-top{top:0;left:0;width:100%;height:100%;border-top-left-radius:5px;border-top-right-radius:5px;clip-path:polygon(0 0,100% 0,100% 50%,0 25%)}.card-stripe-top:after{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.4) 0%,transparent 50%,rgba(0,0,0,.1) 100%);border-top-left-radius:5px;border-top-right-radius:5px;pointer-events:none}.card-stripe-bottom{bottom:0;height:6px;border-bottom-left-radius:5px;border-bottom-right-radius:5px}.card.grey-card .card-stripe-top{height:24px;background:#000}.card.grey-card .card-stripe-bottom{height:3px;background:#000}.color-circle{width:20px;height:20px;border-radius:50%;position:absolute;top:2px;left:5px;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:2px 2px 4px #00000080}.color-circle.blue{background:#4a90e2}.color-circle.white{background:#f0f0f0}.color-circle.green{background:#7ed321}.color-circle.black{background:#2c3e50}.color-circle.red{background:#e74c3c}.wild-icon-positioned{position:absolute;top:25px;left:50%;transform:translate(-50%);z-index:10}.wild-icon-positioned svg{filter:drop-shadow(1px 1px 2px rgba(0,0,0,.5))}.points-corner{position:absolute;top:0;left:0;width:50px;height:50px;background:#f39c12;clip-path:polygon(0 0,0 100%,100% 0)}.card-ability-container{position:absolute;top:4px;right:4px;display:flex;flex-direction:row;align-items:flex-start;gap:3px;z-index:10}.card .double-indicator{position:relative;width:26px;height:18px;display:flex;align-items:center;justify-content:center}.card .double-circle{position:absolute;width:18px;height:18px;border-radius:50%;border:1px solid white;box-shadow:0 2px 4px #0006}.card .double-circle.white{border-color:#999}.card .double-circle-back{top:0;left:0;z-index:1}.card .double-circle-front{top:0;left:8px;z-index:2}.card-ability{width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:1em;line-height:1}.card-ability svg,.card-ability span{width:100%;height:100%;display:flex;align-items:center;justify-content:center}.card-crowns{display:flex;align-items:flex-start;gap:2px;line-height:0}.card-crowns svg{width:16px;height:16px}.card-crowns.crown-stack{flex-direction:column}.card-crowns.crown-grid{display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);gap:2px;width:34px;height:34px}.card-crowns.crown-grid>:nth-child(3){grid-column:1;grid-row:2}.card-crowns.crown-grid>:nth-child(4){grid-column:2;grid-row:2}.card-crowns.crown-grid span{display:block;width:16px;height:16px}.ability-icon{display:inline-flex;align-items:center;justify-content:center;font-size:.9em}.double-bonus{display:flex;flex-direction:column;align-items:center;gap:2px}.double-bonus .color-circle{position:static;width:10px;height:10px;border-radius:50%;border:1px solid rgba(0,0,0,.2);box-shadow:1px 1px 2px #0000004d}.double-plus{font-size:.6em;color:#333;font-weight:700}.card-costs{position:absolute;bottom:8px;left:4px;right:4px;display:grid;grid-template-columns:repeat(2,1fr);gap:2px;max-width:100%}.cost-item{display:flex;align-items:center;justify-content:center;position:relative;height:18px}.cost-item{grid-row:2;grid-column:1}.cost-item.cost-top{grid-row:1}.cost-item.cost-right{grid-column:2}.cost-token{width:18px;height:18px;border-radius:50%;border:1px solid #333;display:flex;align-items:center;justify-content:center;position:relative}.cost-item.blue .cost-token{background:#4a90e2}.cost-item.white .cost-token{background:#f0f0f0}.cost-item.green .cost-token{background:#7ed321}.cost-item.red .cost-token{background:#e74c3c}.cost-item.black .cost-token{background:#2c3e50}.cost-number{font-size:.7em;font-weight:700;color:#fff;text-shadow:1px 1px 1px rgba(0,0,0,.5);line-height:1}.cost-item.white .cost-token .cost-number{color:#333}.cost-amount{font-size:.6em;font-weight:700;color:#fff;text-shadow:1px 1px 1px rgba(0,0,0,.5)}.card-header{position:absolute;top:3px;left:3px;right:3px;display:flex;justify-content:space-between}.card-level{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.7em;color:#fff;background:#666}.level-1{background:#95a5a6}.level-2{background:#3498db}.level-3{background:#e74c3c}.bonus{width:20px;height:20px;border-radius:3px;display:inline-block;margin-right:3px;border:1px solid #333}.card-cost{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:5px}.token-cost{width:25px;height:25px;border-radius:50%;display:inline-block;border:2px solid #333}.token-board{background:transparent;border-radius:4px;position:relative;border:none;max-width:100%}.token-spaces{display:grid;grid-template-columns:repeat(5,1fr);gap:1px}.token-space{aspect-ratio:1;border-radius:50%;position:relative;cursor:pointer;display:flex;align-items:center;justify-content:center}.token-space:hover{background:#ffffff1f}.token{width:60%;height:55%;border-radius:50%;border:1px solid #333;box-shadow:0 1px 2px #0000004d}.game-sidebar-compact{display:flex;flex-direction:column;gap:8px;margin-top:8px}.privileges-compact{display:flex;gap:5px;background:#8b735533;padding:5px;border-radius:6px}.privilege-scroll-compact{width:35px;height:45px;background:linear-gradient(135deg,#8b4513,sienna);border:1px solid #5d4e37;border-radius:5px;cursor:pointer;transition:transform .2s;box-shadow:0 2px 3px #0003;position:relative}.privilege-scroll-compact:hover{transform:scale(1.1)}.privilege-scroll-compact:after{content:"üè∫";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.2em}.royal-cards-compact{display:flex;gap:4px;background:#8b735533;padding:5px;border-radius:6px}.royal-card-compact{width:45px;height:60px;background:linear-gradient(135deg,#d4af37,#f7e98e);border:1px solid #b8941c;border-radius:5px;cursor:pointer;transition:transform .2s;box-shadow:0 2px 4px #0000004d;position:relative}.royal-card-compact:hover{transform:scale(1.1)}.royal-card-compact:after{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5em}.sidebar-header{font-size:.7em;font-weight:700;color:#333;margin-bottom:3px}@media(min-width:900px){.token-board{padding:4px}.token-spaces{gap:1px;padding:2px}}.token-blue{background:var(--token-blue)}.token-white{background:var(--token-white)}.token-green{background:var(--token-green)}.token-black{background:var(--token-black)}.token-red{background:var(--token-red)}.token-gold{background:var(--token-gold)}.token-pearl{background:var(--token-pearl)}.game-sidebar{display:flex;flex-direction:column;gap:8px}.privileges{display:flex;gap:5px;justify-content:center;margin-bottom:5px}.privilege-scroll{width:40px;height:55px;background:linear-gradient(135deg,#8b4513,sienna);border:1px solid #5d4e37;border-radius:6px;cursor:pointer;transition:transform .2s;box-shadow:0 2px 4px #0000004d;position:relative}.privilege-scroll:hover{transform:scale(1.1)}.privilege-scroll:after{content:"üè∫";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5em}.royal-cards{display:flex;flex-direction:column;gap:5px}.royal-card{width:60px;height:85px;background:linear-gradient(135deg,#d4af37,#f7e98e);border:1px solid #b8941c;border-radius:6px;cursor:pointer;transition:transform .2s;box-shadow:0 2px 5px #0000004d;position:relative}.royal-card:hover{transform:scale(1.1)}.royal-card:after{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2em}.player-resources-container{margin-top:10px;border:1px solid #ddd;border-radius:6px;overflow:hidden}.resource-tabs{display:flex;background:#f0f0f0;border-bottom:2px solid #ccc}.resource-tab{flex:1;padding:12px 20px;border:none;background:transparent;cursor:pointer;font-size:1em;font-weight:500;transition:all .2s;border-bottom:3px solid transparent}.resource-tab:hover{background:#e0e0e0}.resource-tab.active{background:#fff;border-bottom-color:#3498db;font-weight:700}.resource-tab-content{display:none;padding:20px;background:#fff}.resource-tab-content.active{display:block}.player-area.compact{background:var(--player-area-bg);padding:15px;border-radius:8px;border:1px solid #ddd}.player-area.compact.opponent{background:var(--opponent-area-bg)}.player-area.compact .player-resources{display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px}.resource-section{background:#fff;border:2px solid #ccc;border-radius:8px;padding:10px}.resource-section h3{font-size:.9em;margin-bottom:10px;color:#555}.player-tokens{display:flex;flex-wrap:wrap;gap:5px}.player-card{width:80px;height:100px;background:var(--card-back);border:2px solid #333;border-radius:6px;display:inline-block;margin-right:5px;margin-bottom:5px;position:relative}.player-card.purchased{border-color:#27ae60;box-shadow:0 2px 4px #27ae604d}.player-card.reserved{opacity:.7;border:2px dashed #999}.crown-icon{position:absolute;top:5px;right:5px;font-size:1.5em;display:flex;align-items:center;justify-content:center}.crown-icon svg{width:100%;height:100%}.prestige-points{font-weight:700;color:#333;font-size:.8em}.card .color-circle .prestige-points{font-size:.9em;font-weight:700;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.5);line-height:1}.card .color-circle.white .prestige-points{color:#333;text-shadow:1px 1px 2px rgba(255,255,255,.5)}.card .points-corner+.prestige-points{position:absolute;top:3px;left:4px;font-size:.8em;font-weight:700;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.5);z-index:3}.card .prestige-points:not(.wild-points):not(.points-corner+.prestige-points):not(.white-points){position:absolute;top:3px;left:4px;font-size:.8em;font-weight:700;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.5);z-index:3}.card .prestige-points.white-points{position:absolute;top:3px;left:6px;font-size:.85em;font-weight:700;color:#333!important;text-shadow:-1px -1px 0 white,1px -1px 0 white,-1px 1px 0 white,1px 1px 0 white,0 -1px 0 white,0 1px 0 white,-1px 0 0 white,1px 0 0 white!important;z-index:10}.big-score{font-size:3em;font-weight:700;color:#333;text-align:center}.crowns{margin-top:10px;font-size:1.5em;text-align:center}.crowns span{font-weight:700;color:#333}.hidden-cards{display:flex;gap:5px}.hidden-card{width:60px;height:80px;background:#444;border:2px solid #222;border-radius:6px;position:relative}.hidden-card:after{content:"üé¥";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5em}.turn-indicator{position:fixed;top:20px;right:20px;background:#27ae60;color:#fff;padding:15px 25px;border-radius:25px;font-weight:700;font-size:1.1em;box-shadow:0 4px 12px #0000004d;z-index:1000}.action-buttons-collapsed{display:flex;justify-content:center;margin-top:10px}.action-buttons-expanded{display:none;margin-top:10px;padding:10px;border:1px solid #ccc;border-radius:6px;background:#f9f9f9}.action-buttons h3{margin-bottom:5px;font-size:.9em;color:#333}.optional-actions,.mandatory-actions{margin-bottom:5px}.optional-actions h4,.mandatory-actions h4{margin-bottom:3px;color:#666;font-size:.8em}button{margin:2px;padding:6px 12px;border:1px solid #333;border-radius:4px;background:#fff;cursor:pointer;font-size:.85em;transition:all .2s}button:hover{background:#f0f0f0;transform:translateY(-1px);box-shadow:0 1px 3px #0003}button:disabled{opacity:.5;cursor:not-allowed;transform:none}button.primary{background:#3498db;color:#fff;border-color:#2980b9}button.primary:hover{background:#2980b9}button.action-trigger{background:#27ae60;color:#fff;border-color:#229954;font-size:1em;padding:10px 25px}.player-status-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.status-totals{display:flex;align-items:center;gap:12px}.big-score-small{font-size:1.6em;font-weight:700;color:#333}.crowns-small{font-size:1.2em;color:#333}.buying-power{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px}.color-power{display:flex;flex-direction:column;align-items:center;gap:3px}.power-visual{width:40px;height:40px;border-radius:50%;border:3px solid #333;display:flex;align-items:center;justify-content:center;position:relative}.power-visual.blue{background:var(--token-blue)}.power-visual.white{background:var(--token-white)}.power-visual.green{background:var(--token-green)}.power-visual.red{background:var(--token-red)}.power-visual.black{background:var(--token-black)}.power-visual.gold{background:var(--token-gold)}.power-visual.pearl{background:var(--token-pearl)}.power-number{font-size:1.2em;font-weight:700;color:#fff;text-shadow:0 0 3px rgba(0,0,0,.5)}.power-breakdown{font-size:.65em;color:#666;text-align:center}.reserved-display{cursor:pointer;padding:6px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5;transition:background .2s}.reserved-display:hover{background:#e8e8e8}.reserved-count{font-size:.85em;font-weight:600;color:#333;margin-bottom:4px;text-align:center}.reserved-cards-mini{display:flex;gap:6px;justify-content:center}.reserved-card-mini{width:35px;height:45px;border:2px solid #333;border-radius:3px;background:var(--card-back);position:relative}.reserved-card-mini.empty{border:2px dashed #ccc;background:#f5f5f5;opacity:.4}.reserved-card-mini.hidden{background:#444;border-color:#222}.reserved-card-mini:not(.empty):not(.hidden):after{content:"üìã";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.1em}.modal-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000000b3;display:none;align-items:center;justify-content:center;z-index:120;pointer-events:auto}.modal-overlay.card-modal-overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:auto}#mode-selection-modal,#join-game-modal,#settings-modal,#session-info-modal{position:absolute;z-index:200;pointer-events:auto;inset:0;width:100%;height:100%}.modal-content{background:transparent;border-radius:0;padding:0;width:100%;height:100%;box-shadow:none;overflow:hidden;display:flex;flex-direction:column}.modal-content.card-detail-content{background:transparent;padding:0;justify-content:stretch;align-items:stretch;overflow:hidden}.modal-body{flex:1;overflow-y:auto;min-height:0;display:flex;flex-direction:column}#token-selection-modal .modal-body{justify-content:flex-start;padding:15px 18px 15px 8px;align-items:flex-start;gap:15px;flex-direction:column;overflow:hidden;min-width:0}.token-modal-layout{width:100%;display:flex;justify-content:center;align-items:flex-start;column-gap:0;row-gap:0;max-width:100%;margin:0 auto;box-sizing:border-box}.token-modal-layout.has-scrolls{column-gap:20px;justify-content:space-between}.token-board-section{display:flex;justify-content:center;flex:0 0 auto}.token-board-wrapper{position:relative;display:inline-flex;justify-content:center}.scroll-usage-section{display:none;flex-direction:column;align-items:center;gap:10px;width:130px;min-width:130px;padding:12px 6px;background:#000000bf;border-radius:10px;box-shadow:0 6px 18px #00000059}.token-modal-layout.has-scrolls .scroll-usage-section{display:flex}.scroll-usage-section .scroll-display-container{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%}.scroll-usage-section .scroll-display-label{font-size:1em;font-weight:600;color:#fff;text-align:center;margin-bottom:8px;white-space:nowrap;text-shadow:0 1px 2px rgba(0,0,0,.3)}.scroll-usage-section .scroll-icons-container{display:flex;gap:8px;justify-content:center;align-items:center}.scroll-usage-section .scroll-icon{cursor:pointer;padding:4px;border-radius:4px;transition:all .2s;display:flex;align-items:center;justify-content:center}.scroll-usage-section .scroll-icon:hover:not(.disabled){background:#4a90e21a;transform:scale(1.1)}.scroll-usage-section .scroll-icon.disabled{opacity:.4;cursor:not-allowed}.scroll-usage-section .scroll-disabled-message{font-size:.75em;color:#fff;text-align:center;margin-top:4px;opacity:.8;text-shadow:0 1px 2px rgba(0,0,0,.3)}.scroll-usage-section .scroll-selection-mode{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%}.scroll-usage-section .scroll-selection-label{font-size:1em;font-weight:600;color:#4a90e2;text-align:center}.scroll-usage-section .btn-confirm-scroll,.scroll-usage-section .btn-cancel-scroll{padding:8px 16px;border:none;border-radius:6px;font-size:.9em;font-weight:600;cursor:pointer;transition:all .2s}.scroll-usage-section .btn-confirm-scroll{background:#4a90e2;color:#fff}.scroll-usage-section .btn-confirm-scroll:hover{background:#357abd;transform:translateY(-1px)}.scroll-usage-section .btn-cancel-scroll{background:#e0e0e0;color:#333}.scroll-usage-section .btn-cancel-scroll:hover{background:#d0d0d0}.token-overlay.scroll-selected{outline:3px solid #4a90e2;outline-offset:-3px;background:#4a90e233}#token-selection-modal .token-selection-content{margin:0;flex:0 0 auto}#token-selection-modal .token-modal-actions{margin:0;padding:0;flex:0 0 auto}.modal-overlay .card,.modal-overlay .card:hover{transform:none!important;box-shadow:0 2px 8px #00000026!important}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-shrink:0}.modal-header h3{margin:0;font-size:1.2em;color:#333}.close-modal{background:none;border:none;font-size:2em;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s}.close-modal:hover{background:#f0f0f0;color:#333}.reserved-cards-view{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;width:100%;max-width:100%}.reserved-card-view{display:flex;flex-direction:column;align-items:center}.hand-display-compact{position:sticky;bottom:0;background:#fff;border-top:2px solid #ddd;padding:8px;margin-top:auto}.hand-display-compact .buying-power{grid-template-columns:repeat(6,1fr);gap:4px}.hand-display-compact .power-visual{width:28px;height:28px}.hand-display-compact .power-number{font-size:.9em}.hand-display-compact .power-breakdown{font-size:.55em}.global-hand-display{background:#e8e4f0;padding:10px 12px 12px;display:flex;flex-direction:column;gap:10px;flex-shrink:0;position:relative;z-index:5}.stat-icon{width:28px;height:28px;border-radius:50%;border:2px solid transparent;position:relative;flex-shrink:0;display:flex;align-items:center;justify-content:center}.stat-count{position:absolute;bottom:-4px;right:-4px;background:#000000a6;color:#fff;font-size:.6em;font-weight:700;border-radius:8px;padding:0 4px}.stat-icon.privilege{background:linear-gradient(135deg,#8b4513,sienna);border-color:#5d3314}.stat-icon.privilege:before{content:"üìú";font-size:.85em}.stat-icon.pearl svg,.stat-icon.gold svg,.stat-icon.crown svg{width:100%;height:100%}.stat-icon.crown{background:linear-gradient(135deg,#d4af37,#f7e98e);border-color:#9b7f23}.stat-icon.crown:before{content:""}.stat-icon.total-points{background:linear-gradient(135deg,#667eea,#764ba2)}.stat-icon.total-points:before{content:"üìä"}.color-cards-row{display:flex;gap:6px;align-items:center}.hand-header-strip,.opponent-header-strip{display:flex;align-items:center;padding:2px 4px;min-height:28px}.hand-stats-group,.opponent-stats-group{display:flex;align-items:center;gap:4px;flex-shrink:0}.hand-stat{display:flex;align-items:center;gap:2px;font-size:.8em;font-weight:600;padding:2px 6px;border-radius:4px;background:#00000014}.hand-stat.score{font-size:.9em;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;min-width:20px;justify-content:center}.hand-stat.crown{background:linear-gradient(135deg,#d4af37,#f7e98e)}.hand-stat.crown svg{width:14px;height:14px}.hand-stat.color-pip{width:18px;height:18px;border-radius:50%;padding:0;justify-content:center;font-size:.7em;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.5)}.hand-stat.color-pip.blue{background:var(--token-blue)}.hand-stat.color-pip.white{background:var(--token-white);color:#333;text-shadow:none}.hand-stat.color-pip.green{background:var(--token-green)}.hand-stat.color-pip.red{background:var(--token-red)}.hand-stat.color-pip.black{background:var(--token-black)}.hand-stat.color-pip.empty{background:#ccc}.hand-resources-group,.opponent-resources-group{display:flex;align-items:center;gap:4px;flex-shrink:0}.hand-reserve-btn-compact{font-size:.8em;padding:5px 10px;border-radius:4px;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;cursor:pointer;font-weight:600;transition:opacity .15s,transform .1s;box-shadow:0 2px 4px #667eea4d}.hand-reserve-btn-compact:hover:not([disabled]){opacity:.9;transform:translateY(-1px);box-shadow:0 3px 6px #667eea66}.hand-reserve-btn-compact[disabled]{opacity:.4;cursor:not-allowed}.misc-cards-fan-inline{position:relative;height:24px;min-width:24px;flex:1;display:flex;justify-content:center}.misc-cards-fan-inner{position:relative;height:24px}.misc-card-tiny{position:absolute;width:18px;height:24px;border:1px solid #666;border-radius:2px;display:flex;align-items:flex-start;justify-content:flex-start;padding:1px 2px;box-shadow:0 1px 2px #0000004d;z-index:1}.misc-card-tiny:hover{z-index:10}.misc-card-pts{font-size:.6em;font-weight:700;color:#fff;text-shadow:1px 1px 1px rgba(0,0,0,.5);line-height:1}.color-card{flex:1;min-width:0;height:100px;border:2px solid #333;border-radius:6px;background:#fff;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:30px 4px 4px}.color-card.blue{border-color:var(--token-blue);background:#4a90e21a}.color-card.white{border-color:var(--token-white);background:#f0f0f04d;border-color:#ccc}.color-card.green{border-color:var(--token-green);background:#7ed3211a}.color-card.red{border-color:var(--token-red);background:#e74c3c1a}.color-card.black{border-color:var(--token-black);background:#2c3e501a}.color-card-empty{background:transparent!important;border:2px dashed #ccc!important}.color-card:not(.color-card-empty){background:#fff!important}.color-card .card-stripe-top,.color-card .card-stripe-bottom{width:100%;position:absolute;left:0;border-radius:6px}.color-card .card-stripe-top{top:0;height:100%;clip-path:polygon(0 0,100% 0,100% 50%,0 25%);z-index:1}.color-card .card-stripe-top:after{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.4) 0%,transparent 50%,rgba(0,0,0,.1) 100%);border-radius:6px;pointer-events:none}.color-card .card-stripe-bottom{bottom:0;height:24px;z-index:1;display:flex;align-items:center;justify-content:center}.hand-tokens-grid{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);gap:8px;width:70%;max-width:60px;z-index:10;pointer-events:none}.hand-token{display:flex;align-items:center;justify-content:center;width:100%;height:100%}.hand-token svg{width:100%;height:100%}.color-card .power-circle{position:absolute;top:-3px;right:-9px;width:26px;height:26px;border-radius:4.5px;display:flex;align-items:center;justify-content:center;font-size:.65em;font-weight:700;color:#fff;text-shadow:0 0 2px rgba(0,0,0,.5);z-index:20;box-shadow:0 2px 4px #0000004d}.color-card .power-circle.white{border:1px solid #ccc;color:#333;text-shadow:none}.wild-token-icon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1;opacity:.7}.color-label{font-size:.65em;font-weight:600;color:#333;text-align:center;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}.card-count{font-size:.55em;color:#666;margin-top:2px}.points-value{position:absolute;bottom:0;left:0;right:0;height:24px;display:flex;align-items:center;justify-content:center;font-size:.75em;font-weight:700;z-index:2}.points-value:not(.white){color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.5)}.points-value.white{color:#333;text-shadow:-1px -1px 0 white,1px -1px 0 white,-1px 1px 0 white,1px 1px 0 white,0 -1px 0 white,0 1px 0 white,-1px 0 0 white,1px 0 0 white}.reserved-section{flex:1;min-width:0;height:100px;border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;padding:4px}.reserved-section-empty{border:2px dashed #999;background:transparent}.reserved-section-filled{border:2px solid #333;background:#fff}.reserved-section:hover{border-color:#777}.reserved-section-filled:hover{background:#f0f0f0}.reserved-section.reserved-affordable{border:3px solid #00D9FF;box-shadow:0 0 10px #00d9ffcc,0 0 20px #00d9ff99,0 0 30px #00d9ff66;animation:affordablePulse 2s ease-in-out infinite}.reserved-icon{font-size:1.5em;margin-bottom:4px}.reserved-count{font-size:1.4em;font-weight:700;color:#333;margin-bottom:2px;text-align:center}.reserved-label{font-size:.55em;color:#666;text-align:center}.royal-cards-view{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;width:100%;max-width:100%;padding:0;box-sizing:border-box}.royal-cards-view.royal-grid-4{display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);gap:8px;width:100%;height:100%;align-items:stretch;justify-items:stretch}.royal-cards-view.royal-grid-3{display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);gap:8px;width:100%;height:100%;align-items:center;justify-items:center}.royal-cards-view.royal-grid-3 .royal-card-view:nth-child(3){grid-column:1;grid-row:2;justify-self:center}.royal-cards-view.royal-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;width:100%;height:100%;align-items:center;justify-items:center}.royal-cards-view.royal-grid-1{display:flex;justify-content:center;align-items:center;width:100%;height:100%}.royal-card-view{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%}.royal-card-large{aspect-ratio:62 / 98;height:100%;width:auto;max-width:100%;max-height:100%;position:relative;background:#fff;overflow:hidden}.royal-card-arch{position:absolute;top:0;right:0;width:100%;height:60%;background:linear-gradient(135deg,#d4af37,#f7e98e);clip-path:ellipse(140% 100% at 100% 0%);z-index:1}.royal-card-arch-dark{position:absolute;top:0;right:0;width:100%;height:40%;background:linear-gradient(135deg,#b8941c,#d4af37,#c9a028);clip-path:ellipse(90% 50% at 60% 40%);z-index:2}.royal-card-stripe-bottom{position:absolute;bottom:0;left:0;width:100%;height:10%;background:linear-gradient(135deg,#d4af37,#f7e98e);border-bottom-left-radius:5px;border-bottom-right-radius:5px;z-index:2}.royal-card-points{position:absolute;top:5%;left:8%;font-size:1.8em;font-weight:700;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,.5);line-height:1;z-index:3}.royal-card-ability{position:absolute;top:5%;right:8%;width:1.5em;height:1.5em;display:flex;align-items:center;justify-content:center;font-size:1.5em;line-height:1;z-index:3;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.8)) drop-shadow(0 0 2px rgba(255,255,255,.3))}.royal-card-crown{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;z-index:3}.royal-card-crown svg{width:2.5em;height:2.5em}.royal-card-clickable{cursor:pointer;transition:transform .2s}.royal-card-clickable:hover{transform:scale(1.05)}.royal-card-selected{outline:4px solid #4a90e2;outline-offset:4px;box-shadow:0 0 20px #4a90e299,0 0 40px #4a90e266}@media(min-width:900px){.global-hand-display{padding:12px}.color-card{height:100px;padding-top:32px}.color-card .power-circle{width:25px;height:25px;border-radius:4.25px;font-size:.65em}.token-dot{width:7.5px;height:7.5px}.token-dots{grid-template-columns:repeat(2,7.5px);grid-template-rows:repeat(2,7.5px);gap:3.75px}.reserved-section{height:100px}.player-toggle{font-size:.85em;padding:6px 14px}.stat-icon{width:32px;height:32px}.stat-count{font-size:.8em}}.global-hand-display.opponent-view{background:linear-gradient(to top,#f5f5f5,#f0f0f0)}.global-hand-display.opponent-view .color-card{opacity:.85}.global-hand-display.opponent-view .reserved-section{background:#e8e8e8;border-color:#bbb}#app{display:flex;flex-direction:column;height:100%}.game-header{flex-shrink:0;position:sticky;top:0;background:#fff;z-index:50;padding:8px}.victory-tracker{display:flex;justify-content:space-between;align-items:center;gap:8px}.victory-tracker-left{display:flex;gap:8px;align-items:center;flex:1}.victory-tracker-right{display:flex;gap:8px;align-items:center;flex:1;justify-content:flex-end;flex-wrap:wrap}.opponent-label-wrapper{width:100%;text-align:center}.victory-stat{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;min-height:40px}.victory-stat.large{min-height:60px;min-width:50px}.victory-stat.small{min-width:35px;min-height:32px}.victory-icon-backdrop{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;opacity:.45;z-index:1}.victory-icon-backdrop svg{width:100%;height:100%}.victory-stat.large .victory-icon-backdrop{font-size:2.5em}.victory-stat.small .victory-icon-backdrop{font-size:1.5em}.victory-icon-backdrop.color{width:32px;height:32px;border-radius:4px;border:2px solid #333;opacity:.4}.victory-stat.large .victory-icon-backdrop.color{width:40px;height:40px}.victory-stat.small .victory-icon-backdrop.color{width:28px;height:28px}.victory-icon-backdrop.color.blue{background:var(--token-blue);border-color:var(--token-blue)}.victory-icon-backdrop.color.white{background:var(--token-white);border-color:#ccc}.victory-icon-backdrop.color.green{background:var(--token-green);border-color:var(--token-green)}.victory-icon-backdrop.color.red{background:var(--token-red);border-color:var(--token-red)}.victory-icon-backdrop.color.black{background:var(--token-black);border-color:var(--token-black)}.victory-icon-backdrop.color.empty{background:transparent!important;border:2px dashed #999;opacity:.5}.victory-value.overlaid{position:relative;z-index:2;color:#333;font-weight:700;text-shadow:-1px -1px 0 white,1px -1px 0 white,-1px 1px 0 white,1px 1px 0 white,-1px 0 0 white,1px 0 0 white,0 -1px 0 white,0 1px 0 white,-2px -2px 0 white,2px -2px 0 white,-2px 2px 0 white,2px 2px 0 white}.victory-label{font-size:.6em;color:#666;font-weight:500}.victory-value{font-size:1.2em;font-weight:700;color:#333;text-align:center}.victory-stat.large .victory-value{font-size:2em}.victory-stat.large .victory-value.score-value-large{font-size:3.2em}.victory-stat.large .victory-value.score-value-large:before{content:"+";font-size:.5em;opacity:.7;vertical-align:top;line-height:1.2}.victory-stat.large .victory-value.overlaid{font-size:1.8em}.victory-stat.small .victory-value,.victory-stat.small .victory-value.overlaid{font-size:1em}.victory-stat.small .victory-label{font-size:.55em}.opponent-display-wrapper{display:flex;flex-direction:column;align-items:center}.player-scrolls{display:flex;gap:2px}.player-scrolls .privilege-scroll-emoji{font-size:1.4em}.opponent-label{font-size:.5em;color:#999;text-transform:uppercase;letter-spacing:.5px;margin-top:4px;text-align:center;width:100%;flex-basis:100%}.color-value{display:flex;align-items:center;gap:4px}.color-indicator{width:16px;height:16px;border-radius:3px;border:1px solid #333}.color-indicator.blue{background:var(--token-blue)}.color-indicator.white{background:var(--token-white)}.color-indicator.green{background:var(--token-green)}.color-indicator.red{background:var(--token-red)}.color-indicator.black{background:var(--token-black)}.color-count{font-weight:700}.royal-cards-summary{display:flex;align-items:center;gap:4px;background:linear-gradient(135deg,#d4af37,#f7e98e);border:2px solid #b8941c;border-radius:4px;padding:4px 8px;cursor:pointer;transition:all .2s}.royal-cards-summary:hover{transform:translateY(-1px);box-shadow:0 2px 4px #0003}.royal-card-icon{font-size:1.2em}.royal-card-count{font-size:.9em;font-weight:700;color:#333}.privileges-summary{display:flex;gap:2px;justify-content:center}.privilege-scroll-emoji{font-size:1.4em}.game-header h1{font-size:1em;color:#333;margin-bottom:1px}.game-status{font-size:.7em;color:#666}@media(min-width:900px){.game-header{padding:8px}.game-header h1{font-size:1.3em}.game-status{font-size:.85em}}.resource-summary{display:flex;gap:4px;margin:5px 0;padding:4px;background:#f5f5f5;border-radius:4px;border:1px solid #ddd;font-size:.7em;flex-wrap:wrap;justify-content:center}.resource-summary-item{display:flex;align-items:center;gap:3px;padding:2px 4px;background:#fff;border-radius:3px;border:1px solid #ccc}.token-mini{width:16px;height:16px;border-radius:50%;border:1px solid #333;display:inline-block}.token-mini.blue{background:var(--token-blue)}.token-mini.white{background:var(--token-white)}.token-mini.green{background:var(--token-green)}.token-mini.black{background:var(--token-black)}.token-mini.red{background:var(--token-red)}.token-mini.gold{background:var(--token-gold)}.token-mini.pearl{background:var(--token-pearl)}.victory-tile{background:linear-gradient(135deg,gold,#ffed4e);border:3px solid #d4af37;border-radius:10px;padding:15px;margin-bottom:20px;text-align:center;box-shadow:0 4px 8px #00000026}.victory-conditions{display:flex;justify-content:space-around;gap:15px}.condition{flex:1;padding:10px;background:#fffc;border-radius:8px;border:2px solid #d4af37}.condition h3{font-size:1em;margin-bottom:5px;color:#333}.condition-value{font-size:1.5em;font-weight:700;color:#8b4513}.royal-cards-summary.card-shaped{width:62px;height:98px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:3px;position:relative;background:#f0f0f0;border:2px solid #999;flex-shrink:0;flex-grow:0;border-radius:6px;cursor:pointer;transition:transform .2s,box-shadow .2s}.royal-cards-summary.royal-cards-empty{border:2px dashed #999;background:linear-gradient(135deg,#e0e0e0,#f5f5f5);cursor:not-allowed;opacity:.6}.royal-cards-summary.royal-cards-empty:hover{transform:none;box-shadow:none}.royal-icon-greyed{opacity:.4;filter:grayscale(100%)}.royal-cards-summary.card-shaped:hover{transform:translateY(-5px);box-shadow:0 4px 12px #0000004d}.royal-card-icon-centered{font-size:2em;margin-top:12px;margin-bottom:8px}.royal-card-label{font-size:1.1em;color:#333;font-weight:600;position:absolute;bottom:6px;right:6px;white-space:nowrap;background:#ffffffe6;padding:2px 6px;border-radius:3px}@media(min-width:900px){.royal-cards-summary.card-shaped{width:65px;height:102px}.royal-card-icon-centered{font-size:2.2em}.royal-card-label{font-size:1.2em}}.restore-discard-button{background:linear-gradient(135deg,#ff9800,#ffb84d)!important;border:2px solid #e68900!important;cursor:pointer!important;animation:restorePulse 2s ease-in-out infinite}.restore-discard-button:hover{transform:translateY(-5px) scale(1.05);box-shadow:0 6px 16px #e6890080}@keyframes restorePulse{0%,to{box-shadow:0 2px 8px #e6890066}50%{box-shadow:0 4px 16px #e68900b3}}#confirmation-modal{z-index:200;pointer-events:auto}#confirmation-modal .confirmation-content{max-width:360px;width:90%;padding:20px;text-align:center;background:#000000d9;border-radius:12px;box-shadow:0 8px 32px #00000080;animation:slideUp .3s ease;display:flex;flex-direction:column;gap:16px}.confirmation-message{margin-bottom:0}.confirmation-message p{font-size:1em;color:#fff;margin:0;font-weight:500;text-shadow:0 1px 3px rgba(0,0,0,.5);line-height:1.5}.confirmation-actions{display:flex;gap:12px;justify-content:center;margin-top:8px}.confirmation-actions .btn-cancel,.confirmation-actions .btn-confirm{flex:1;padding:12px 24px;font-size:1.1em;font-weight:600;border-radius:8px;cursor:pointer;border:none;transition:transform .1s,box-shadow .1s}.confirmation-actions .btn-cancel{background:#666;color:#fff}.confirmation-actions .btn-cancel:hover{background:#555;transform:translateY(-2px)}.confirmation-actions .btn-confirm{background:linear-gradient(135deg,#4caf50,#45a049);color:#fff}.confirmation-actions .btn-confirm:hover{transform:translateY(-2px);box-shadow:0 4px 8px #4caf5066}.privileges-overlay{position:absolute;bottom:-18px;left:-6px;display:flex;gap:3px;align-items:center;justify-content:center}.pyramid-info-corner .privilege-scroll-emoji{font-size:1.6em}.action-button{padding:12px 24px;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer!important;transition:all .2s;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 4px 12px #667eea66;pointer-events:auto!important;position:relative;z-index:10}.action-button:hover{transform:translateY(-2px);box-shadow:0 6px 16px #667eea80;background:linear-gradient(135deg,#7a8ef0,#8655b8)}.action-button:active{transform:translateY(0)}.action-button:disabled{opacity:.5;cursor:not-allowed}.buy-button{background-color:#4a90e2;color:#fff}.buy-button:hover{background-color:#357abd}.reserve-button{background-color:#7ed321;color:#fff}.reserve-button:hover{background-color:#6bbf0f}.reserve-button-top-right{position:absolute;top:0;right:0;padding:4px 8px;font-size:.85em;z-index:1000;margin:0;border-radius:4px 0 0 4px}.cancel-button{background-color:#999;color:#fff}.cancel-button:hover{background-color:#777}.large-card{transform:scale(2);transform-origin:center}.token-selection-content{display:flex;flex-direction:column;justify-content:center;align-items:center;margin:15px 0;flex:0 1 auto;min-height:0;position:relative}.token-board-svg{background:transparent;border:none;border-radius:8px;padding:0}#token-click-overlays{position:absolute;top:0;left:50%;transform:translate(-50%);width:220px;height:220px;z-index:10;pointer-events:none}.token-overlay{background:transparent;transition:all .2s;pointer-events:auto;z-index:20}.token-overlay.selected{background:#4a90e233;box-shadow:inset 0 0 0 2px #4a90e2}.token-overlay:hover:not(.gold-token):not(.empty):not(.selected){background:#ffffff1a}.token-overlay.gold-token,.token-overlay.empty{pointer-events:none;cursor:not-allowed}.token-modal-actions{display:flex;justify-content:center;gap:10px;padding:0;flex-shrink:0;flex-wrap:nowrap;width:100%;box-sizing:border-box;margin-top:auto}.btn-cancel,.btn-confirm,.btn-refill{padding:10px 20px;font-size:14px;font-weight:600;border:none;border-radius:6px;cursor:pointer;transition:all .2s;flex:1;min-width:0;max-width:none}.btn-cancel{background-color:#999;color:#fff;pointer-events:auto!important;cursor:pointer!important;padding:8px 16px;font-size:14px;border:none;border-radius:6px;transition:all .2s;position:relative;z-index:10}.btn-cancel:hover{background-color:#777}.btn-confirm{background-color:#4a90e2;color:#fff}.btn-confirm:hover{background-color:#357abd}.btn-cancel:hover,.btn-confirm:hover{transform:translateY(-2px);box-shadow:0 4px 8px #0003}.btn-refill{background-color:#5cb85c;color:#fff}.btn-refill:hover:not(:disabled){background-color:#4cae4c;transform:translateY(-2px);box-shadow:0 4px 8px #0003}.btn-refill:disabled{background-color:#ccc;cursor:not-allowed;opacity:.6}#turn-completion-dialog{z-index:200;pointer-events:auto}#turn-completion-dialog .modal-content{justify-content:center;align-items:center;background:#000000b3;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);pointer-events:auto}.game-container.dialog-blocking *{pointer-events:none}.game-container.dialog-blocking #turn-completion-dialog,.game-container.dialog-blocking #turn-completion-dialog *,.game-container.dialog-blocking #repeat-turn-dialog,.game-container.dialog-blocking #repeat-turn-dialog *,.game-container.dialog-blocking #royal-modal,.game-container.dialog-blocking #royal-modal *,.game-container.dialog-blocking #mode-selection-modal,.game-container.dialog-blocking #mode-selection-modal *,.game-container.dialog-blocking #join-game-modal,.game-container.dialog-blocking #join-game-modal *,.game-container.dialog-blocking #settings-modal,.game-container.dialog-blocking #settings-modal *,.game-container.dialog-blocking #session-info-modal,.game-container.dialog-blocking #session-info-modal *,.game-container.dialog-blocking #confirmation-modal,.game-container.dialog-blocking #confirmation-modal *{pointer-events:auto}.turn-completion-content{max-width:320px;width:90%;max-height:85vh;padding:24px;text-align:center;background:#fff;border-radius:12px;box-shadow:0 8px 32px #0000004d;animation:slideUp .3s ease;pointer-events:auto;position:relative;z-index:201;display:flex;flex-direction:column;overflow:hidden}.turn-completion-message{margin-bottom:20px;flex-shrink:0}.turn-completion-message h3{font-size:1.4em;margin-bottom:8px;color:#4a90e2;font-weight:700}.turn-completion-message p{font-size:1em;color:#555;margin:0;font-weight:500;line-height:1.5}.switch-players-button{width:100%;padding:12px 24px;font-size:1.1em;font-weight:600;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;cursor:pointer;transition:all .2s;box-shadow:0 4px 12px #667eea66;flex-shrink:0;margin-top:auto}.switch-players-button:hover{transform:translateY(-2px);box-shadow:0 6px 16px #667eea80}.switch-players-button:active{transform:translateY(0)}#player-hand.switching,#opponent-stats.switching,.player-stats-bar.switching{opacity:.3;transform:scale(.98);transition:opacity .3s ease,transform .3s ease}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}@keyframes slideUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}#token-discard-modal{z-index:200;pointer-events:auto}#token-discard-modal .token-discard-content{max-width:360px;width:90%;padding:16px;text-align:center;background:#000000d9;border-radius:12px;box-shadow:0 8px 32px #00000080;animation:slideUp .3s ease;display:flex;flex-direction:column;gap:12px}.token-discard-message{margin-bottom:0}.token-discard-message p{font-size:.95em;color:#fff;margin:0;font-weight:500;text-shadow:0 1px 3px rgba(0,0,0,.5);line-height:1.4}.token-discard-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;padding:12px;background:#ffffff1a;border-radius:8px}.token-discard-item{cursor:pointer;display:flex;align-items:center;justify-content:center;padding:4px;border-radius:8px;background:#ffffff1a;transition:all .2s;border:2px solid transparent}.token-discard-item:hover{background:#fff3;transform:scale(1.1)}.token-discard-item.selected{background:#4a90e24d;border:3px solid #4a90e2;box-shadow:0 0 15px #4a90e299}.token-discard-item svg{filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}.token-discard-actions{display:flex;justify-content:center;gap:12px;margin-top:10px}.token-discard-actions .btn-minimize{padding:12px 20px;font-size:1em;font-weight:600;background:#666;color:#fff;border:none;border-radius:8px;cursor:pointer}.token-discard-actions .btn-minimize:hover{background:#555}.token-discard-actions .btn-confirm{padding:12px 32px;font-size:1.1em;font-weight:600;min-width:150px}.game-container.dialog-blocking #token-discard-modal,.game-container.dialog-blocking #token-discard-modal *{pointer-events:auto}.game-container.discard-pending .card-v2,.game-container.discard-pending .token-board,.game-container.discard-pending .action-button,.game-container.discard-pending .reserve-button,.game-container.discard-pending .hand-reserve-btn-compact,.game-container.discard-pending .btn-confirm,.game-container.discard-pending .btn-cancel{pointer-events:none;opacity:.7}.game-container.discard-pending #discard-pending-container,.game-container.discard-pending #discard-pending-container *,.game-container.discard-pending .reserved-section,.game-container.discard-pending #reserved-modal,.game-container.discard-pending #reserved-modal .modal-content,.game-container.discard-pending #reserved-modal .cancel-button,.game-container.discard-pending #card-detail-popover,.game-container.discard-pending #card-detail-popover .modal-content,.game-container.discard-pending #card-detail-popover .cancel-button,.game-container.discard-pending #royal-modal,.game-container.discard-pending #royal-modal .modal-content,.game-container.discard-pending #token-selection-modal,.game-container.discard-pending #token-selection-modal .modal-content,.game-container.discard-pending #token-selection-modal .btn-cancel{pointer-events:auto;opacity:1}.game-container.discard-pending #card-detail-popover .buy-button,.game-container.discard-pending #reserved-modal .buy-button,.game-container.discard-pending #token-selection-modal .btn-confirm,.game-container.discard-pending #token-selection-modal .btn-refill{pointer-events:none!important;opacity:.4!important}.discard-pending-container{display:flex;align-items:center;gap:8px}.discard-pending-message{font-size:.75em;color:#666;text-align:right;line-height:1.3;max-width:80px}.discard-pending-message span{display:block}</style>
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>
